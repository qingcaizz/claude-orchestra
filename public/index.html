<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000000">
<title>AGENT VIEWER</title>
<style>
/* ─── RESET & BASE ──────────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --green: #00ff00;
  --amber: #ffaa00;
  --dim: #666;
  --white: #fff;
  --bg: #000;
  --border: #444;
  --card-bg: #0a0a0a;
  --input-bg: #111;
  --red: #ff4444;
  --font: 'SF Mono', 'JetBrains Mono', 'Menlo', 'Consolas', 'Courier New', monospace;
}

html, body {
  background: var(--bg);
  color: var(--white);
  font-family: var(--font);
  font-size: 13px;
  line-height: 1.5;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ─── SCANLINE EFFECT ───────────────────────────────────────────────── */
body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0, 0, 0, 0.03) 2px,
    rgba(0, 0, 0, 0.03) 4px
  );
  z-index: 10000;
}

/* ─── HEADER ────────────────────────────────────────────────────────── */
header {
  border-bottom: 2px solid var(--white);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

header h1 {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 4px;
  text-transform: uppercase;
}

header .status-bar {
  font-size: 11px;
  color: var(--dim);
  letter-spacing: 1px;
  text-transform: uppercase;
}

header .status-bar .dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: var(--green);
  margin-right: 6px;
  animation: blink 2s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.spawn-btn {
  background: none;
  border: 2px solid var(--green);
  color: var(--green);
  padding: 8px 20px;
  font-family: var(--font);
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.1s;
}

.spawn-btn:hover {
  background: var(--green);
  color: var(--bg);
}

/* ─── KANBAN BOARD ──────────────────────────────────────────────────── */
.board {
  display: flex;
  gap: 0;
  min-height: calc(100vh - 70px);
}

.column {
  flex: 1;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  min-height: 300px;
}

.column:last-child {
  border-right: none;
}

.column-header {
  padding: 12px 16px;
  border-bottom: 2px solid var(--border);
  font-weight: 700;
  font-size: 12px;
  letter-spacing: 3px;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 10px;
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}

.column-header .indicator {
  width: 10px;
  height: 10px;
  display: inline-block;
}

.column[data-state="running"] .column-header .indicator { background: var(--green); }
.column[data-state="idle"] .column-header .indicator { background: var(--amber); }
.column[data-state="completed"] .column-header .indicator { background: var(--dim); }

.column-header .count {
  color: var(--dim);
  font-weight: 400;
}

.clear-all-btn {
  margin-left: auto;
  background: none;
  border: 1px solid var(--dim);
  color: var(--dim);
  font-family: var(--font);
  font-size: 10px;
  padding: 2px 8px;
  cursor: pointer;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: all 0.1s;
}

.clear-all-btn:hover {
  border-color: var(--red);
  color: var(--red);
}

.column-body {
  flex: 1;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-y: auto;
  transition: background 0.2s;
}

.column-body.drag-over {
  background: rgba(255, 255, 255, 0.03);
  outline: 2px dashed var(--border);
  outline-offset: -4px;
}

/* ─── AGENT CARDS ───────────────────────────────────────────────────── */
.card {
  border: 1px solid var(--border);
  background: var(--card-bg);
  cursor: grab;
  user-select: none;
}

.card.dragging {
  opacity: 0.4;
}

.card-titlebar {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.card[data-state="running"] .card-titlebar { border-bottom-color: var(--green); }
.card[data-state="idle"] .card-titlebar { border-bottom-color: var(--amber); }
.card[data-state="completed"] .card-titlebar { border-bottom-color: var(--dim); }

.card-titlebar .state-badge {
  font-size: 10px;
  padding: 2px 6px;
  letter-spacing: 1px;
}

.card[data-state="running"] .state-badge { color: var(--green); border: 1px solid var(--green); }
.card[data-state="idle"] .state-badge { color: var(--amber); border: 1px solid var(--amber); }
.card[data-state="completed"] .state-badge { color: var(--dim); border: 1px solid var(--dim); }

.card-titlebar .prompt-badge {
  font-size: 10px;
  padding: 2px 6px;
  letter-spacing: 1px;
  color: #000;
  background: var(--amber);
  border: 1px solid var(--amber);
  cursor: pointer;
  animation: prompt-pulse 2s ease-in-out infinite;
}

@keyframes prompt-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.card-body {
  padding: 10px 12px;
  font-size: 11px;
  line-height: 1.6;
}

.card-body .meta {
  color: var(--dim);
  margin-bottom: 2px;
}

.card-body .meta span {
  color: var(--white);
}

.card-body .activity {
  margin-top: 8px;
  padding: 6px 8px;
  background: var(--bg);
  border: 1px solid #222;
  color: #ccc;
  font-size: 11px;
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 80px;
  overflow-y: hidden;
  line-height: 1.5;
}

/* ─── FILE DROP ZONE ON CARDS ──────────────────────────────────────── */
.card.file-drag-over {
  outline: 2px dashed var(--green);
  outline-offset: -2px;
  background: rgba(0, 255, 0, 0.03);
}

.card .drop-hint {
  display: none;
  padding: 8px;
  text-align: center;
  color: var(--green);
  font-size: 11px;
  letter-spacing: 1px;
  text-transform: uppercase;
  border-top: 1px solid var(--border);
}

.card.file-drag-over .drop-hint {
  display: block;
}


/* ─── CARD PROMPT INPUT ─────────────────────────────────────────────── */
.card-prompt {
  border-top: 1px solid var(--border);
  padding: 8px;
}

.card-prompt .prompt-row {
  display: flex;
  gap: 0;
}

.card-prompt .prompt-prefix {
  padding: 6px 8px;
  background: var(--bg);
  border: 1px solid #333;
  border-right: none;
  color: var(--green);
  font-size: 11px;
  display: flex;
  align-items: center;
}

.card-prompt textarea {
  flex: 1;
  background: var(--bg);
  border: 1px solid #333;
  border-left: none;
  color: var(--white);
  font-family: var(--font);
  font-size: 11px;
  padding: 6px 8px;
  resize: none;
  height: 32px;
  outline: none;
}

.card-prompt textarea:focus {
  border-color: var(--green);
}

.card-prompt textarea::placeholder {
  color: #555;
}

/* ─── CARD ACTIONS ──────────────────────────────────────────────────── */
.card-actions {
  border-top: 1px solid var(--border);
  padding: 8px 12px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.card-actions button {
  background: none;
  border: 1px solid var(--border);
  color: var(--white);
  font-family: var(--font);
  font-size: 10px;
  padding: 4px 10px;
  cursor: pointer;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: all 0.1s;
}

.card-actions button:hover {
  background: var(--white);
  color: var(--bg);
}

.card-actions .btn-stop {
  border-color: var(--red);
  color: var(--red);
}

.card-actions .btn-stop:hover {
  background: var(--red);
  color: var(--white);
}

.card-actions .btn-send {
  border-color: var(--green);
  color: var(--green);
}

.card-actions .btn-send:hover {
  background: var(--green);
  color: var(--bg);
}

.card-actions .btn-clear {
  border-color: var(--dim);
  color: var(--dim);
}

.card-actions .btn-clear:hover {
  background: var(--dim);
  color: var(--bg);
}

/* ─── SPAWN MODAL ───────────────────────────────────────────────────── */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  border: 2px solid var(--white);
  background: var(--bg);
  width: 500px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 12px 16px;
  border-bottom: 2px solid var(--white);
  font-weight: 700;
  font-size: 13px;
  letter-spacing: 3px;
  text-transform: uppercase;
}

.modal-body {
  padding: 16px;
}

.form-field {
  margin-bottom: 14px;
}

.form-field label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--dim);
  margin-bottom: 6px;
}

.form-field .input-row {
  display: flex;
  gap: 0;
}

.form-field .input-prefix {
  padding: 8px 10px;
  background: #111;
  border: 1px solid var(--border);
  border-right: none;
  color: var(--green);
  font-size: 12px;
}

.form-field input,
.form-field select,
.form-field textarea {
  flex: 1;
  background: var(--input-bg);
  border: 1px solid var(--border);
  color: var(--white);
  font-family: var(--font);
  font-size: 12px;
  padding: 8px 10px;
  outline: none;
  width: 100%;
}

.form-field input:focus,
.form-field select:focus,
.form-field textarea:focus {
  border-color: var(--green);
}

.form-field select {
  appearance: none;
  cursor: pointer;
}

.form-field textarea {
  height: 100px;
  resize: vertical;
}

/* ─── Project Path Combo Box ─────────────────────────────── */
.combo-wrapper {
  position: relative;
  flex: 1;
  display: flex;
}
.combo-wrapper input {
  flex: 1;
}
.combo-toggle {
  background: #111;
  border: 1px solid var(--border);
  border-left: none;
  color: var(--dim);
  font-size: 10px;
  padding: 0 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
}
.combo-toggle:hover {
  color: var(--green);
}
.combo-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-top: none;
  max-height: 180px;
  overflow-y: auto;
  z-index: 1000;
}
.combo-dropdown.open {
  display: block;
}
.combo-option {
  padding: 7px 10px;
  font-size: 12px;
  color: var(--dim);
  cursor: pointer;
  font-family: var(--font);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.combo-option:hover,
.combo-option.active {
  background: rgba(0, 255, 65, 0.08);
  color: var(--green);
}
.combo-empty {
  padding: 7px 10px;
  font-size: 11px;
  color: var(--dim);
  font-style: italic;
}

.modal-actions {
  padding: 12px 16px;
  border-top: 2px solid var(--border);
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.modal-actions button {
  background: none;
  border: 2px solid var(--border);
  color: var(--white);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 700;
  padding: 8px 20px;
  cursor: pointer;
  letter-spacing: 2px;
  text-transform: uppercase;
  transition: all 0.1s;
}

.modal-actions .btn-spawn {
  border-color: var(--green);
  color: var(--green);
}

.modal-actions .btn-spawn:hover {
  background: var(--green);
  color: var(--bg);
}

.modal-actions .btn-cancel:hover {
  background: var(--white);
  color: var(--bg);
}

/* ─── OUTPUT VIEWER OVERLAY ─────────────────────────────────────────── */
.output-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 2000;
  flex-direction: column;
}

.output-overlay.active {
  display: flex;
}

.output-header {
  padding: 12px 16px;
  border-bottom: 2px solid var(--white);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 700;
  font-size: 12px;
  letter-spacing: 2px;
  text-transform: uppercase;
  flex-shrink: 0;
}

.output-header .close-btn {
  background: none;
  border: 1px solid var(--white);
  color: var(--white);
  font-family: var(--font);
  font-size: 12px;
  padding: 4px 12px;
  cursor: pointer;
  letter-spacing: 1px;
}

.output-header .close-btn:hover {
  background: var(--white);
  color: var(--bg);
}

.output-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  font-size: 12px;
  line-height: 1.6;
  color: #ccc;
  white-space: pre-wrap;
  word-break: break-all;
}

.output-prompt {
  border-top: 2px solid var(--border);
  padding: 12px 16px;
  display: flex;
  gap: 0;
  flex-shrink: 0;
}

.output-prompt .prefix {
  padding: 10px 12px;
  background: #111;
  border: 1px solid var(--border);
  border-right: none;
  color: var(--green);
  font-size: 13px;
}

.output-prompt input {
  flex: 1;
  background: var(--input-bg);
  border: 1px solid var(--border);
  color: var(--white);
  font-family: var(--font);
  font-size: 13px;
  padding: 10px 12px;
  outline: none;
}

.output-prompt input:focus {
  border-color: var(--green);
}

.output-prompt button {
  padding: 10px 20px;
  background: none;
  border: 1px solid var(--green);
  border-left: none;
  color: var(--green);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  cursor: pointer;
  text-transform: uppercase;
}

.output-prompt button:hover {
  background: var(--green);
  color: var(--bg);
}

/* ─── CONFIRM DIALOG ────────────────────────────────────────────────── */
.confirm-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 3000;
  align-items: center;
  justify-content: center;
}

.confirm-overlay.active {
  display: flex;
}

.confirm-box {
  border: 2px solid var(--amber);
  background: var(--bg);
  padding: 24px;
  max-width: 400px;
  text-align: center;
}

.confirm-box p {
  margin-bottom: 20px;
  font-size: 13px;
  letter-spacing: 1px;
}

.confirm-box .confirm-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
}

.confirm-box button {
  background: none;
  border: 2px solid var(--border);
  color: var(--white);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 700;
  padding: 8px 24px;
  cursor: pointer;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.confirm-box .btn-confirm {
  border-color: var(--red);
  color: var(--red);
}

.confirm-box .btn-confirm:hover {
  background: var(--red);
  color: var(--white);
}

.confirm-box .btn-no:hover {
  background: var(--white);
  color: var(--bg);
}

/* ─── EMPTY STATE ───────────────────────────────────────────────────── */
.empty-state {
  color: #333;
  text-align: center;
  padding: 40px 20px;
  font-size: 12px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* ─── MOBILE TAB BAR ───────────────────────────────────────────────── */
.mobile-tabs {
  display: none;
  border-bottom: 2px solid var(--border);
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 20;
}

.mobile-tabs .tab-bar {
  display: flex;
}

.mobile-tabs .tab {
  flex: 1;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--dim);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 14px 8px;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.mobile-tabs .tab.active {
  color: var(--white);
  border-bottom-color: var(--white);
}

.mobile-tabs .tab[data-tab="running"].active {
  color: var(--green);
  border-bottom-color: var(--green);
}

.mobile-tabs .tab[data-tab="idle"].active {
  color: var(--amber);
  border-bottom-color: var(--amber);
}

.mobile-tabs .tab[data-tab="completed"].active {
  color: var(--dim);
  border-bottom-color: var(--dim);
}

.mobile-tabs .tab .tab-count {
  font-weight: 400;
  font-size: 11px;
  opacity: 0.7;
}

/* ─── MOBILE FLOAT BUTTON ───────────────────────────────────────────── */
.fab {
  display: none;
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  background: var(--green);
  color: var(--bg);
  border: none;
  font-family: var(--font);
  font-size: 24px;
  font-weight: 700;
  cursor: pointer;
  z-index: 100;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  box-shadow: 0 4px 12px rgba(0, 255, 0, 0.3);
  -webkit-tap-highlight-color: transparent;
}

.fab:active {
  transform: scale(0.92);
}

/* ─── MOBILE ────────────────────────────────────────────────────────── */
@media (max-width: 768px) {
  html, body {
    font-size: 14px;
    -webkit-text-size-adjust: 100%;
  }

  /* Disable scanline on mobile for perf/battery */
  body::after {
    display: none;
  }

  /* Safe area insets for notched phones */
  header {
    padding: 12px 16px;
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
  }

  header h1 {
    font-size: 15px;
    letter-spacing: 2px;
  }

  header .status-bar {
    font-size: 10px;
  }

  header .spawn-btn {
    display: none;
  }

  /* Show mobile tab bar */
  .mobile-tabs {
    display: block;
  }

  /* Tab-based column switching */
  .board {
    flex-direction: column;
    min-height: calc(100vh - 120px);
  }

  .column {
    border-right: none;
    border-bottom: none;
    min-height: auto;
    display: none;
    flex: 1;
  }

  .column.mobile-active {
    display: flex;
    flex: 1;
  }

  .column-header {
    display: none;
  }

  .column-body {
    min-height: calc(100vh - 160px);
    padding: 12px;
    padding-left: max(12px, env(safe-area-inset-left));
    padding-right: max(12px, env(safe-area-inset-right));
    padding-bottom: 96px; /* room for FAB */
    gap: 14px;
  }

  /* FAB with safe area */
  .fab {
    display: flex;
    bottom: max(24px, env(safe-area-inset-bottom, 24px));
    right: max(24px, env(safe-area-inset-right, 24px));
    width: 60px;
    height: 60px;
    font-size: 28px;
  }

  /* Card improvements for touch */
  .card {
    border-radius: 4px;
    cursor: default;
  }

  .card-titlebar {
    padding: 12px 14px;
    font-size: 12px;
  }

  .card-titlebar .state-badge {
    font-size: 10px;
    padding: 3px 8px;
  }

  .card-body {
    padding: 12px 14px;
    font-size: 12px;
  }

  .card-body .activity {
    font-size: 11px;
    max-height: 60px;
    border-radius: 2px;
  }

  /* Prompt input - bigger for touch */
  .card-prompt {
    padding: 10px;
  }

  .card-prompt .prompt-prefix {
    padding: 10px;
    font-size: 13px;
  }

  .card-prompt textarea {
    font-size: 14px;
    padding: 10px;
    height: 42px;
    /* iOS zoom prevention */
    border-radius: 0;
    -webkit-appearance: none;
  }

  /* Action buttons - touch friendly */
  .card-actions {
    padding: 10px 12px;
    gap: 8px;
    flex-wrap: wrap;
  }

  .card-actions button {
    padding: 10px 16px;
    font-size: 11px;
    min-height: 40px;
    border-radius: 2px;
    -webkit-tap-highlight-color: transparent;
  }

  .card-actions button:active {
    opacity: 0.7;
  }

  /* Modal - full screen with safe areas */
  .modal-overlay {
    align-items: stretch;
    justify-content: stretch;
  }

  .modal {
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    border: none;
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    padding: 14px 16px;
    padding-left: max(16px, env(safe-area-inset-left));
  }

  .modal-body {
    padding: 16px;
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
    flex: 1;
    overflow-y: auto;
  }

  .form-field input,
  .form-field textarea {
    font-size: 16px; /* prevents iOS zoom on focus */
    padding: 12px;
  }

  .form-field textarea {
    height: 120px;
  }

  .modal-actions {
    padding: 14px 16px;
    padding-bottom: max(14px, env(safe-area-inset-bottom));
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
  }

  .modal-actions button {
    padding: 12px 24px;
    min-height: 44px;
    font-size: 13px;
    flex: 1;
  }

  /* Output viewer - mobile optimized */
  .output-header {
    padding: 14px 16px;
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
    font-size: 11px;
  }

  .output-header .close-btn {
    padding: 8px 16px;
    font-size: 12px;
    min-height: 36px;
  }

  .output-content {
    padding: 12px;
    padding-left: max(12px, env(safe-area-inset-left));
    padding-right: max(12px, env(safe-area-inset-right));
    font-size: 11px;
    -webkit-overflow-scrolling: touch;
  }

  .output-prompt {
    padding: 10px;
    padding-bottom: max(10px, env(safe-area-inset-bottom));
    padding-left: max(10px, env(safe-area-inset-left));
    padding-right: max(10px, env(safe-area-inset-right));
  }

  .output-prompt .prefix {
    padding: 12px;
    font-size: 14px;
  }

  .output-prompt input {
    font-size: 16px; /* prevents iOS zoom */
    padding: 12px;
    -webkit-appearance: none;
    border-radius: 0;
  }

  .output-prompt button {
    padding: 12px 18px;
    font-size: 12px;
    min-height: 44px;
  }

  /* Confirm dialog */
  .confirm-box {
    margin: 16px;
    padding: 24px 20px;
    max-width: calc(100vw - 32px);
  }

  .confirm-box p {
    font-size: 14px;
  }

  .confirm-box button {
    padding: 12px 24px;
    min-height: 44px;
    font-size: 12px;
  }

  /* Empty state */
  .empty-state {
    padding: 60px 20px;
    font-size: 13px;
  }

  /* Disable drag on mobile */
  .card[draggable] {
    -webkit-user-drag: none;
  }
}

/* ─── KEY CONTROLS (for interactive prompts) ───────────────────────── */
.key-controls {
  border-top: 1px solid var(--border);
  padding: 8px 12px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

.key-controls .kc-label {
  font-size: 10px;
  color: var(--amber);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-right: 4px;
}

.key-controls button {
  background: none;
  border: 1px solid var(--amber);
  color: var(--amber);
  font-family: var(--font);
  font-size: 11px;
  font-weight: 700;
  padding: 4px 10px;
  cursor: pointer;
  letter-spacing: 1px;
  transition: all 0.1s;
  min-width: 32px;
  text-align: center;
}

.key-controls button:hover {
  background: var(--amber);
  color: var(--bg);
}

.key-controls button:active {
  transform: scale(0.95);
}

/* ─── FOLDER PICKER ────────────────────────────────────────────────── */
.browse-btn {
  padding: 8px 12px;
  background: none;
  border: 1px solid var(--border);
  border-left: none;
  color: var(--green);
  font-family: var(--font);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
  cursor: pointer;
  text-transform: uppercase;
  white-space: nowrap;
}

.browse-btn:hover {
  background: var(--green);
  color: var(--bg);
}

.folder-picker {
  display: none;
  border: 1px solid var(--border);
  background: var(--bg);
  margin-top: 6px;
  max-height: 250px;
  overflow-y: auto;
}

.folder-picker.active {
  display: block;
}

.folder-picker .fp-header {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
  color: var(--green);
  word-break: break-all;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.folder-picker .fp-header .fp-select {
  background: none;
  border: 1px solid var(--green);
  color: var(--green);
  font-family: var(--font);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 10px;
  cursor: pointer;
  letter-spacing: 1px;
  text-transform: uppercase;
  white-space: nowrap;
}

.folder-picker .fp-header .fp-select:hover {
  background: var(--green);
  color: var(--bg);
}

.folder-picker .fp-item {
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
  border-bottom: 1px solid #111;
  color: var(--white);
}

.folder-picker .fp-item:hover {
  background: #111;
  color: var(--green);
}

.folder-picker .fp-item.fp-parent {
  color: var(--dim);
}

.folder-picker .fp-empty {
  padding: 12px 10px;
  font-size: 11px;
  color: #333;
  text-align: center;
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* ─── VIEW TABS ────────────────────────────────────────────────────── */
.view-tabs {
  display: flex;
  gap: 0;
}

.view-tab {
  background: none;
  border: 1px solid var(--border);
  color: var(--dim);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 6px 16px;
  cursor: pointer;
  transition: all 0.1s;
}

.view-tab:first-child {
  border-right: none;
}

.view-tab.active {
  background: var(--white);
  color: var(--bg);
  border-color: var(--white);
}

.view-tab:not(.active):hover {
  border-color: var(--white);
  color: var(--white);
}

/* ─── TEAMS VIEW ───────────────────────────────────────────────────── */
.teams-view {
  display: none;
  min-height: calc(100vh - 70px);
}

.teams-view.active {
  display: flex;
}

.agents-view {
  display: flex;
}

.agents-view:not(.active) {
  display: none;
}

/* Team List Sidebar */
.team-list {
  width: 240px;
  min-width: 240px;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}

.team-list-header {
  padding: 12px 16px;
  border-bottom: 2px solid var(--border);
  font-weight: 700;
  font-size: 12px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--dim);
}

.team-list-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.team-list-item {
  padding: 10px 12px;
  border: 1px solid transparent;
  cursor: pointer;
  margin-bottom: 4px;
  transition: all 0.1s;
}

.team-list-item:hover {
  border-color: var(--border);
  background: var(--card-bg);
}

.team-list-item.active {
  border-color: var(--green);
  background: var(--card-bg);
}

.team-list-item .tli-name {
  font-weight: 700;
  font-size: 12px;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.team-list-item .tli-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}

.team-list-item .tli-dot.active { background: var(--green); }
.team-list-item .tli-dot.idle { background: var(--amber); }
.team-list-item .tli-dot.inactive { background: var(--dim); border: 1px solid var(--dim); }

.team-list-item .tli-meta {
  font-size: 10px;
  color: var(--dim);
  margin-top: 4px;
  letter-spacing: 1px;
}

.team-list-empty {
  color: #333;
  text-align: center;
  padding: 40px 16px;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* Team Detail Panel */
.team-detail {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.team-detail-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #333;
  font-size: 12px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* Member Status Bar */
.team-members-bar {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  overflow-x: auto;
}

.member-card {
  border: 1px solid var(--border);
  background: var(--card-bg);
  padding: 8px 12px;
  min-width: 120px;
  flex-shrink: 0;
}

.member-card .mc-name {
  font-weight: 700;
  font-size: 11px;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.member-card .mc-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}

.member-card .mc-dot.working { background: var(--green); }
.member-card .mc-dot.idle { background: var(--amber); }
.member-card .mc-dot.offline { background: none; border: 1px dashed var(--dim); }
.member-card .mc-status.offline { color: var(--dim); }

.mc-wake-btn {
  background: none;
  border: 1px solid var(--green);
  color: var(--green);
  font-family: var(--font);
  font-size: 9px;
  font-weight: 700;
  padding: 1px 6px;
  cursor: pointer;
  letter-spacing: 1px;
  margin-left: auto;
}
.mc-wake-btn:hover { background: var(--green); color: #000; }

.member-card .mc-model {
  font-size: 10px;
  color: var(--dim);
  margin-top: 2px;
}

.member-card .mc-status {
  font-size: 10px;
  color: var(--dim);
  margin-top: 2px;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.member-card .mc-status.working { color: var(--green); }
.member-card .mc-status.idle { color: var(--amber); }

/* Team Main Content - Task Board + Messages */
.team-content {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* Task Kanban */
.team-tasks {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.team-tasks-header {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--dim);
}

.team-kanban {
  flex: 1;
  display: flex;
  overflow: hidden;
}

.tk-column {
  flex: 1;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.tk-column:last-child {
  border-right: none;
}

.tk-column-header {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

.tk-column-header .tk-ind {
  width: 8px;
  height: 8px;
  display: inline-block;
}

.tk-column[data-status="pending"] .tk-ind { background: var(--dim); }
.tk-column[data-status="in_progress"] .tk-ind { background: var(--green); }
.tk-column[data-status="completed"] .tk-ind { background: #50fa7b; opacity: 0.5; }

.tk-column-header .tk-count {
  color: var(--dim);
  font-weight: 400;
}

.tk-column-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Task Card */
.task-card {
  border: 1px solid var(--border);
  background: var(--card-bg);
  padding: 10px 12px;
}

.task-card .tc-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
}

.task-card .tc-id {
  font-size: 10px;
  color: var(--dim);
  font-weight: 700;
  flex-shrink: 0;
}

.task-card .tc-subject {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.5px;
  flex: 1;
  word-break: break-word;
}

.task-card .tc-owner {
  margin-top: 6px;
  font-size: 10px;
  color: var(--dim);
}

.task-card .tc-owner span {
  color: var(--green);
}

.task-card .tc-active-form {
  margin-top: 4px;
  font-size: 10px;
  color: var(--amber);
  font-style: italic;
  letter-spacing: 0.5px;
}

.task-card .tc-deps {
  margin-top: 6px;
  font-size: 10px;
  color: var(--dim);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.task-card .tc-dep-blocked {
  color: var(--red);
}

.task-card .tc-dep-blocks {
  color: var(--amber);
}

.tk-empty {
  color: #333;
  text-align: center;
  padding: 20px 8px;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* Messages Panel */
.team-messages {
  width: 300px;
  min-width: 300px;
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}

.team-messages-header {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--dim);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.team-messages-toggle {
  background: none;
  border: 1px solid var(--border);
  color: var(--dim);
  font-family: var(--font);
  font-size: 10px;
  padding: 2px 8px;
  cursor: pointer;
  letter-spacing: 1px;
}

.team-messages-toggle:hover {
  border-color: var(--white);
  color: var(--white);
}

.team-messages-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px 12px;
}

.msg-item {
  padding: 6px 0;
  border-bottom: 1px solid #111;
  font-size: 11px;
  line-height: 1.5;
}

.msg-item:last-child {
  border-bottom: none;
}

.msg-time {
  color: var(--dim);
  font-size: 10px;
}

.msg-route {
  font-weight: 700;
  font-size: 10px;
  letter-spacing: 0.5px;
}

.msg-type-message .msg-route { color: var(--white); }
.msg-type-task .msg-route { color: var(--green); }
.msg-type-shutdown_request .msg-route { color: var(--red); }
.msg-type-plan_approval_request .msg-route { color: var(--amber); }
.msg-type-broadcast .msg-route { color: #8be9fd; }

.msg-text {
  color: #ccc;
  font-size: 11px;
  word-break: break-word;
  max-height: 60px;
  overflow: hidden;
}

.msg-empty {
  color: #333;
  text-align: center;
  padding: 40px 8px;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* Collapsed messages */
.team-messages.collapsed {
  width: 40px;
  min-width: 40px;
}

.team-messages.collapsed .team-messages-header span,
.team-messages.collapsed .team-messages-body {
  display: none;
}

/* ─── TEAMS MOBILE ─────────────────────────────────────────────────── */
@media (max-width: 768px) {
  .teams-view.active {
    flex-direction: column;
  }

  .team-list {
    width: 100%;
    min-width: 100%;
    max-height: 200px;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }

  .team-list-body {
    display: flex;
    overflow-x: auto;
    gap: 8px;
    padding: 8px;
  }

  .team-list-item {
    min-width: 160px;
    margin-bottom: 0;
  }

  .team-content {
    flex-direction: column;
  }

  .team-messages {
    width: 100%;
    min-width: 100%;
    max-height: 200px;
    border-left: none;
    border-top: 1px solid var(--border);
  }

  .team-messages.collapsed {
    width: 100%;
    min-width: 100%;
    max-height: 40px;
  }

  .team-kanban {
    flex-direction: column;
  }

  .tk-column {
    border-right: none;
    border-bottom: 1px solid var(--border);
    max-height: 250px;
  }

  .view-tabs {
    gap: 0;
  }

  .view-tab {
    padding: 4px 10px;
    font-size: 10px;
    letter-spacing: 1px;
  }
}

/* ─── MEMBER DETAIL MODAL ──────────────────────────────────────────── */
.member-modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 2500;
  align-items: center;
  justify-content: center;
}

.member-modal-overlay.active {
  display: flex;
}

.member-modal {
  border: 2px solid var(--white);
  background: var(--bg);
  width: 900px;
  max-width: 95vw;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
}

.member-modal-header {
  padding: 12px 16px;
  border-bottom: 2px solid var(--white);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.member-modal-header .mm-title {
  font-weight: 700;
  font-size: 13px;
  letter-spacing: 2px;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 10px;
}

.member-modal-header .mm-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.member-modal-header .mm-actions button {
  background: none;
  border: 1px solid var(--border);
  color: var(--white);
  font-family: var(--font);
  font-size: 11px;
  padding: 4px 12px;
  cursor: pointer;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: all 0.1s;
}

.member-modal-header .mm-btn-stop {
  border-color: var(--red) !important;
  color: var(--red) !important;
}

.member-modal-header .mm-btn-stop:hover {
  background: var(--red) !important;
  color: var(--white) !important;
}

.member-modal-header .mm-btn-close:hover {
  background: var(--white);
  color: var(--bg);
}

.member-modal-body {
  flex: 1;
  display: flex;
  overflow: hidden;
}

.mm-info-sidebar {
  width: 260px;
  min-width: 260px;
  border-right: 1px solid var(--border);
  overflow-y: auto;
  padding: 12px;
}

.mm-info-section {
  margin-bottom: 14px;
}

.mm-info-label {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--dim);
  margin-bottom: 4px;
}

.mm-info-value {
  font-size: 11px;
  color: var(--white);
  line-height: 1.5;
  word-break: break-word;
}

.mm-info-value.dim {
  color: var(--dim);
}

.mm-prompt-text {
  font-size: 11px;
  color: #ccc;
  line-height: 1.5;
  max-height: 200px;
  overflow-y: auto;
  padding: 6px 8px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  white-space: pre-wrap;
  word-break: break-word;
}

.mm-usage {
  display: flex;
  gap: 12px;
}

.mm-usage-item {
  font-size: 11px;
}

.mm-usage-item .usage-label {
  color: var(--dim);
  font-size: 10px;
  letter-spacing: 1px;
}

.mm-usage-item .usage-val {
  color: var(--green);
  font-weight: 700;
}

.mm-transcript-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.mm-transcript-header {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--dim);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.mm-transcript-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.mm-msg {
  padding: 8px 10px;
  border: 1px solid var(--border);
  background: var(--card-bg);
  font-size: 11px;
  line-height: 1.6;
}

.mm-msg.user {
  border-left: 3px solid var(--amber);
}

.mm-msg.assistant {
  border-left: 3px solid var(--green);
}

.mm-msg.tool {
  border-left: 3px solid var(--dim);
  color: var(--dim);
  font-size: 10px;
}

.mm-msg-role {
  font-weight: 700;
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 4px;
}

.mm-msg.user .mm-msg-role { color: var(--amber); }
.mm-msg.assistant .mm-msg-role { color: var(--green); }
.mm-msg.tool .mm-msg-role { color: var(--dim); }

.mm-msg-text {
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 200px;
  overflow-y: auto;
}

.mm-msg-tools {
  margin-top: 6px;
  font-size: 10px;
  color: var(--dim);
}

.mm-msg-tool-item {
  padding: 2px 0;
}

.mm-msg-tool-item .tool-name {
  color: #8be9fd;
  font-weight: 700;
}

.mm-transcript-empty {
  color: #333;
  text-align: center;
  padding: 40px;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.mm-send-bar {
  border-top: 1px solid var(--border);
  padding: 8px 12px;
  display: flex;
  gap: 0;
  flex-shrink: 0;
}

.mm-send-bar .prefix {
  padding: 8px 10px;
  background: #111;
  border: 1px solid var(--border);
  border-right: none;
  color: var(--green);
  font-size: 12px;
}

.mm-send-bar input {
  flex: 1;
  background: var(--input-bg);
  border: 1px solid var(--border);
  color: var(--white);
  font-family: var(--font);
  font-size: 12px;
  padding: 8px 10px;
  outline: none;
}

.mm-send-bar input:focus {
  border-color: var(--green);
}

.mm-send-bar button {
  padding: 8px 16px;
  background: none;
  border: 1px solid var(--green);
  border-left: none;
  color: var(--green);
  font-family: var(--font);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
  cursor: pointer;
  text-transform: uppercase;
}

.mm-send-bar button:hover {
  background: var(--green);
  color: var(--bg);
}

/* Member card clickable */
.member-card.clickable {
  cursor: pointer;
  transition: all 0.1s;
}

.member-card.clickable:hover {
  border-color: var(--green);
  background: rgba(0, 255, 0, 0.03);
}

/* Message reply */
.msg-reply-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--dim);
  font-family: var(--font);
  font-size: 9px;
  padding: 1px 6px;
  cursor: pointer;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-left: 8px;
}

.msg-reply-btn:hover {
  border-color: var(--green);
  color: var(--green);
}

/* Team message send bar */
.team-send-bar {
  border-top: 1px solid var(--border);
  padding: 8px;
  display: flex;
  gap: 0;
  flex-shrink: 0;
}

.team-send-bar select {
  background: #111;
  border: 1px solid var(--border);
  border-right: none;
  color: var(--green);
  font-family: var(--font);
  font-size: 10px;
  padding: 6px 8px;
  outline: none;
  min-width: 80px;
  appearance: none;
  cursor: pointer;
}

.team-send-bar input {
  flex: 1;
  background: var(--input-bg);
  border: 1px solid var(--border);
  color: var(--white);
  font-family: var(--font);
  font-size: 11px;
  padding: 6px 8px;
  outline: none;
}

.team-send-bar input:focus {
  border-color: var(--green);
}

.team-send-bar button {
  padding: 6px 12px;
  background: none;
  border: 1px solid var(--green);
  border-left: none;
  color: var(--green);
  font-family: var(--font);
  font-size: 10px;
  font-weight: 700;
  cursor: pointer;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.team-send-bar button:hover {
  background: var(--green);
  color: var(--bg);
}

/* Task card actions */
.tc-actions {
  margin-top: 8px;
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

.tc-actions select,
.tc-actions button {
  background: none;
  border: 1px solid var(--border);
  color: var(--dim);
  font-family: var(--font);
  font-size: 9px;
  padding: 2px 6px;
  cursor: pointer;
  letter-spacing: 0.5px;
  appearance: none;
}

.tc-actions select:hover,
.tc-actions button:hover {
  border-color: var(--green);
  color: var(--green);
}

@media (max-width: 768px) {
  .member-modal {
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    border: none;
  }

  .member-modal-body {
    flex-direction: column;
  }

  .mm-info-sidebar {
    width: 100%;
    min-width: 100%;
    max-height: 200px;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }
}

/* Timeline */
.team-timeline { flex:1; overflow-y:auto; padding:12px 16px; }
.tl-event { display:flex; gap:10px; padding:8px 10px; border-bottom:1px solid #111; cursor:pointer; transition:background 0.1s; font-size:11px; align-items:flex-start; }
.tl-event:hover { background:rgba(255,255,255,0.03); }
.tl-event .tl-time { color:var(--dim); font-size:10px; white-space:nowrap; min-width:60px; flex-shrink:0; }
.tl-event .tl-actor { font-weight:700; font-size:10px; letter-spacing:0.5px; min-width:80px; flex-shrink:0; }
.tl-event .tl-summary { flex:1; color:#ccc; word-break:break-word; }
.tl-event .tl-mark { flex-shrink:0; font-size:12px; }
.tl-event[data-type="task_completed"] { border-left:3px solid #50fa7b; }
.tl-event[data-type="task_completed"] .tl-mark { color:#50fa7b; }
.tl-event[data-type="plan_approval"] { border-left:3px solid var(--amber); background:rgba(255,170,0,0.05); }
.tl-event[data-type="plan_approval"] .tl-mark { color:var(--amber); }
.tl-event[data-type="shutdown"] { border-left:3px solid var(--red); }
.tl-event[data-type="boss_message"] { border-left:3px solid #8be9fd; }
.tl-event[data-type="boss_message"] .tl-actor { color:#8be9fd; }
.tl-event[data-type="broadcast"] .tl-actor { color:#8be9fd; }
.tl-event[data-type="task_started"] { border-left:3px solid var(--green); }
.tl-event[data-type="message"] { border-left:3px solid #bd93f9; }
.tl-event[data-type="agent_message"] { border-left:3px solid #bd93f9; }
.tl-event[data-type="agent_activity"] { border-left:3px solid #6272a4; opacity:0.8; }
.tl-event[data-type="peer_dm"] { border-left:3px solid #ffb86c; }
.tl-event[data-type="shutdown_approved"] { border-left:3px solid var(--red); }
.tl-event .tl-direction { font-size:9px; color:var(--dim); letter-spacing:0.5px; white-space:nowrap; min-width:100px; flex-shrink:0; }
.tl-event .tl-direction .tl-arrow { color:var(--amber); margin:0 2px; }
.tl-detail { display:none; padding:8px 12px; margin:0 10px 8px 80px; background:var(--card-bg); border:1px solid var(--border); font-size:11px; color:#ccc; white-space:pre-wrap; word-break:break-word; max-height:300px; overflow-y:auto; }
.tl-detail.open { display:block; }
.tl-expand-hint { font-size:9px; color:var(--dim); margin-left:4px; flex-shrink:0; }
.tl-empty { color:#333; text-align:center; padding:40px 16px; font-size:11px; letter-spacing:2px; text-transform:uppercase; }

/* Agent role colors for timeline */
.tl-role-0 { color:#8be9fd; }
.tl-role-1 { color:#bd93f9; }
.tl-role-2 { color:#ff79c6; }
.tl-role-3 { color:#f1fa8c; }
.tl-role-4 { color:#ffb86c; }
.tl-role-5 { color:#50fa7b; }
.tl-role-6 { color:#ff5555; }
.tl-role-7 { color:#6272a4; }

/* Member card dynamic summary */
.mc-activity { font-size:9px; color:#aaa; margin-top:4px; max-height:28px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:160px; }
.mc-task-label { font-size:9px; color:var(--green); margin-top:2px; letter-spacing:0.5px; }

/* Timeline filter */
.timeline-filter { display:flex; gap:4px; }
.filter-btn { font-size:10px; padding:4px 10px; border:1px solid var(--border); color:var(--dim); cursor:pointer; letter-spacing:1px; transition:all 0.1s; }
.filter-btn:hover { border-color:var(--white); color:var(--white); }
.filter-btn.active { border-color:var(--green); color:var(--green); font-weight:700; }

/* Member inline expansion */
.member-activity-inline { padding:8px 12px; margin:4px 0; background:var(--card-bg); border:1px solid var(--border); font-size:10px; max-height:200px; overflow-y:auto; }
.member-activity-inline .mai-item { padding:4px 0; border-bottom:1px solid #111; }
.member-activity-inline .mai-item:last-child { border-bottom:none; }

/* Boss input area */
.boss-input { border-top:2px solid var(--border); padding:12px 16px; display:flex; gap:8px; align-items:center; flex-shrink:0; }
.boss-input select { background:var(--input-bg); border:1px solid var(--border); color:var(--white); font-family:var(--font); font-size:11px; padding:6px 8px; }
.boss-input input[type="text"] { flex:1; background:var(--input-bg); border:1px solid var(--border); color:var(--white); font-family:var(--font); font-size:11px; padding:6px 10px; outline:none; }
.boss-input input[type="text"]:focus { border-color:var(--green); }
.boss-input button { background:none; border:1px solid var(--green); color:var(--green); font-family:var(--font); font-size:10px; font-weight:700; padding:6px 14px; cursor:pointer; letter-spacing:1px; text-transform:uppercase; transition:all 0.1s; }
.boss-input button:hover { background:var(--green); color:var(--bg); }
.boss-input .quick-actions { display:flex; gap:4px; }
.boss-input .quick-btn { background:none; border:1px solid var(--border); color:var(--dim); font-family:var(--font); font-size:9px; padding:4px 8px; cursor:pointer; letter-spacing:0.5px; transition:all 0.1s; }
.boss-input .quick-btn:hover { border-color:var(--white); color:var(--white); }

/* ─── SCROLLBAR ─────────────────────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: #333; }
::-webkit-scrollbar-thumb:hover { background: #555; }
</style>
</head>
<body>

<!-- ─── HEADER ─────────────────────────────────────────────────────── -->
<header>
  <h1>AGENT VIEWER</h1>
  <div class="view-tabs">
    <button class="view-tab active" data-view="agents" onclick="switchView('agents')">AGENTS</button>
    <button class="view-tab" data-view="teams" onclick="switchView('teams')">TEAMS</button>
  </div>
  <div class="status-bar">
    <span class="dot"></span>
    <span id="connectionStatus">CONNECTING...</span>
  </div>
  <button class="spawn-btn" onclick="openSpawnModal()">[+ SPAWN] <span style="color:var(--dim);font-size:10px;font-weight:400">(N)</span></button>
</header>

<!-- ─── AGENTS VIEW ─────────────────────────────────────────────────── -->
<div class="agents-view active" id="agentsView">

<!-- ─── MOBILE TAB BAR ─────────────────────────────────────────────── -->
<div class="mobile-tabs">
  <div class="tab-bar">
    <button class="tab active" data-tab="running" onclick="switchTab('running')">
      RUN <span class="tab-count" id="tabRunCount">[0]</span>
    </button>
    <button class="tab" data-tab="idle" onclick="switchTab('idle')">
      IDLE <span class="tab-count" id="tabIdleCount">[0]</span>
    </button>
    <button class="tab" data-tab="completed" onclick="switchTab('completed')">
      DONE <span class="tab-count" id="tabDoneCount">[0]</span>
    </button>
  </div>
</div>

<!-- ─── KANBAN BOARD ───────────────────────────────────────────────── -->
<div class="board">
  <div class="column" data-state="running">
    <div class="column-header">
      <span class="indicator"></span>
      RUNNING <span class="count" id="runningCount">[0]</span>
    </div>
    <div class="column-body" id="runningColumn">
      <div class="empty-state">NO RUNNING AGENTS</div>
    </div>
  </div>

  <div class="column" data-state="idle">
    <div class="column-header">
      <span class="indicator"></span>
      IDLE <span class="count" id="idleCount">[0]</span>
    </div>
    <div class="column-body" id="idleColumn">
      <div class="empty-state">NO IDLE AGENTS</div>
    </div>
  </div>

  <div class="column" data-state="completed">
    <div class="column-header">
      <span class="indicator"></span>
      COMPLETED <span class="count" id="completedCount">[0]</span>
      <button class="clear-all-btn" id="clearAllBtn" onclick="confirmClearAll()" style="display:none">CLEAR ALL</button>
    </div>
    <div class="column-body" id="completedColumn"
         ondragover="onDragOver(event)" ondragleave="onDragLeave(event)"
         ondrop="onDrop(event, 'completed')">
      <div class="empty-state">NO COMPLETED AGENTS</div>
    </div>
  </div>
</div>

</div><!-- /agents-view -->

<!-- ─── TEAMS VIEW ─────────────────────────────────────────────────── -->
<div class="teams-view" id="teamsView">
  <div class="team-list">
    <div class="team-list-header">TEAMS</div>
    <div class="team-list-body" id="teamListBody">
      <div class="team-list-empty">NO TEAMS DETECTED</div>
    </div>
  </div>
  <div class="team-detail" id="teamDetail">
    <div class="team-detail-empty">SELECT A TEAM</div>
  </div>
</div>

<!-- ─── MOBILE FAB ─────────────────────────────────────────────────── -->
<button class="fab" onclick="openSpawnModal()">+</button>

<!-- ─── SPAWN MODAL ────────────────────────────────────────────────── -->
<div class="modal-overlay" id="spawnModal">
  <div class="modal">
    <div class="modal-header">SPAWN NEW AGENT</div>
    <div class="modal-body">
      <div class="form-field">
        <label>PROJECT PATH</label>
        <div class="input-row">
          <span class="input-prefix">&gt;_</span>
          <div class="combo-wrapper">
            <input type="text" id="spawnProject" placeholder="C:\Users\EDY\projects"
                   autocomplete="off"
                   oninput="filterRecentProjects()"
                   onfocus="filterRecentProjects()"
                   onkeydown="comboKeydown(event)" />
            <button type="button" class="combo-toggle" onclick="toggleProjectDropdown()" title="Recent projects">&#9660;</button>
            <div class="combo-dropdown" id="projectDropdown"></div>
          </div>
          <button class="browse-btn" onclick="toggleFolderPicker()">BROWSE</button>
        </div>
        <div class="folder-picker" id="folderPicker"></div>
      </div>
      <div class="form-field">
        <label>PROMPT</label>
        <div class="input-row" style="align-items:start">
          <span class="input-prefix" style="padding-top:10px">&gt;_</span>
          <textarea id="spawnPrompt" placeholder="Describe the task for the agent..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeSpawnModal()">CANCEL</button>
      <button class="btn-spawn" onclick="spawnAgent()">SPAWN</button>
    </div>
  </div>
</div>

<!-- ─── OUTPUT VIEWER ──────────────────────────────────────────────── -->
<div class="output-overlay" id="outputOverlay">
  <div class="output-header">
    <span id="outputTitle">OUTPUT</span>
    <button class="close-btn" onclick="closeOutputViewer()">[X] CLOSE</button>
  </div>
  <div class="output-content" id="outputContent"></div>
  <div class="key-controls" id="outputKeyControls" style="display:none"></div>
  <div class="output-prompt">
    <span class="prefix">&gt;_</span>
    <input type="text" id="outputPromptInput" placeholder="Send a message..."
           onkeydown="if(event.key==='Enter'){sendFromOutput();}" />
    <button onclick="sendFromOutput()">SEND</button>
  </div>
</div>

<!-- ─── MEMBER DETAIL MODAL ────────────────────────────────────────── -->
<div class="member-modal-overlay" id="memberModal">
  <div class="member-modal">
    <div class="member-modal-header">
      <div class="mm-title">
        <span id="mmDot" class="mc-dot"></span>
        <span id="mmName">AGENT</span>
        <span id="mmModel" style="color:var(--dim);font-size:10px;font-weight:400"></span>
      </div>
      <div class="mm-actions">
        <button class="mm-btn-stop" id="mmStopBtn" onclick="shutdownTeamAgent()">STOP</button>
        <button class="mm-btn-close" onclick="closeMemberModal()">[X] CLOSE</button>
      </div>
    </div>
    <div class="member-modal-body">
      <div class="mm-info-sidebar" id="mmInfoSidebar">
        <!-- Filled by JS -->
      </div>
      <div class="mm-transcript-panel">
        <div class="mm-transcript-header">
          <span>CONVERSATION</span>
          <span id="mmTranscriptCount" style="font-weight:400"></span>
        </div>
        <div class="mm-transcript-body" id="mmTranscriptBody">
          <div class="mm-transcript-empty">LOADING...</div>
        </div>
        <div class="mm-send-bar">
          <span class="prefix">&gt;_</span>
          <input type="text" id="mmSendInput" placeholder="Send a message to this agent..."
                 onkeydown="if(event.key==='Enter')sendToTeamAgent()" />
          <button onclick="sendToTeamAgent()">SEND</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ─── CONFIRM DIALOG ─────────────────────────────────────────────── -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <p id="confirmMessage">STOP THIS AGENT?</p>
    <div class="confirm-actions">
      <button class="btn-no" onclick="closeConfirm()">CANCEL</button>
      <button class="btn-confirm" id="confirmBtn" onclick="confirmAction()">STOP</button>
    </div>
  </div>
</div>

<script>
// ─── STATE ─────────────────────────────────────────────────────────────
let agents = [];
let currentOutputAgent = null;
let outputPollTimer = null;
let pendingConfirm = null;
let draggedAgentName = null;

// ─── SSE CONNECTION ────────────────────────────────────────────────────
let eventSource = null;

function connectSSE() {
  if (eventSource) eventSource.close();
  eventSource = new EventSource('/api/events');

  eventSource.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      if (data.type === 'connected') {
        document.getElementById('connectionStatus').textContent = 'CONNECTED';
      } else if (data.type === 'agents') {
        agents = data.agents;
        renderBoard();
      } else if (data.type === 'teams') {
        handleTeamsUpdate(data);
      }
    } catch (e) {
      console.error('SSE parse error:', e);
    }
  };

  eventSource.onerror = () => {
    document.getElementById('connectionStatus').textContent = 'RECONNECTING...';
    setTimeout(connectSSE, 3000);
  };
}

// Also fetch immediately on load
async function fetchAgents() {
  try {
    const res = await fetch('/api/agents');
    agents = await res.json();
    renderBoard();
  } catch (e) {
    console.error('Fetch error:', e);
  }
}

// ─── RENDERING ─────────────────────────────────────────────────────────
function renderBoard() {
  const running = agents.filter(a => a.state === 'running');
  const idle = agents.filter(a => a.state === 'idle');
  const completed = agents.filter(a => a.state === 'completed');

  document.getElementById('runningCount').textContent = `[${running.length}]`;
  document.getElementById('idleCount').textContent = `[${idle.length}]`;
  document.getElementById('completedCount').textContent = `[${completed.length}]`;

  renderColumn('runningColumn', running, 'NO RUNNING AGENTS');
  renderColumn('idleColumn', idle, 'NO IDLE AGENTS');
  renderColumn('completedColumn', completed, 'NO COMPLETED AGENTS');

  // Show/hide clear all button
  document.getElementById('clearAllBtn').style.display = completed.length > 0 ? '' : 'none';

  // Update mobile tab counts
  updateMobileTabs();

  // Keep mobile column visibility in sync
  if (isMobile()) {
    document.querySelectorAll('.column').forEach(col => {
      col.classList.toggle('mobile-active', col.dataset.state === activeTab);
    });
  }

  // Update output viewer if open
  if (currentOutputAgent) {
    updateOutputViewer();
  }
}

function renderColumn(columnId, columnAgents, emptyText) {
  const el = document.getElementById(columnId);

  // Preserve focused textarea state before re-render
  const focused = el.querySelector('textarea:focus');
  let focusedId = null;
  let focusedValue = null;
  let focusedSelStart = null;
  let focusedSelEnd = null;
  if (focused) {
    focusedId = focused.id;
    focusedValue = focused.value;
    focusedSelStart = focused.selectionStart;
    focusedSelEnd = focused.selectionEnd;
  }

  if (columnAgents.length === 0) {
    el.innerHTML = `<div class="empty-state">${emptyText}</div>`;
    return;
  }

  el.innerHTML = columnAgents.map(a => renderCard(a)).join('');

  // Restore focused textarea state after re-render
  if (focusedId) {
    const restored = document.getElementById(focusedId);
    if (restored) {
      restored.value = focusedValue;
      restored.focus();
      restored.selectionStart = focusedSelStart;
      restored.selectionEnd = focusedSelEnd;
    }
  }
}

function renderCard(agent) {
  const uptime = agent.createdAt ? formatDuration(Date.now() - agent.createdAt) : '--';
  const idleFor = agent.idleSince ? formatDuration(Date.now() - agent.idleSince) : '';
  const projectName = agent.projectPath ? agent.projectPath.split(/[\\/]/).filter(Boolean).pop() : '--';
  const lastActHtml = ansiToHtml(agent.lastActivity || '');

  let metaLines = '';
  metaLines += `<div class="meta">PROJECT: <span>${escapeHtml(projectName)}</span></div>`;
  metaLines += `<div class="meta">UPTIME: <span>${uptime}</span></div>`;

  if (agent.state === 'idle') {
    metaLines += `<div class="meta">IDLE FOR: <span>${idleFor}</span></div>`;
  } else if (agent.state === 'completed') {
    const completedAgo = agent.completedAt ? formatDuration(Date.now() - agent.completedAt) + ' AGO' : '--';
    metaLines += `<div class="meta">COMPLETED: <span>${completedAgo}</span></div>`;
  }

  const activityBlock = lastActHtml
    ? `<div class="activity">${lastActHtml}</div>`
    : '';

  // Interactive key controls for selection/permission prompts
  // Use server-side detection, with client-side fallback from activity text
  const promptType = agent.promptType || detectPromptTypeFromText(agent.lastActivity || '');
  let keyControlsBlock = '';
  if (promptType) {
    let buttons = '';
    const n = agent.name;
    if (promptType === 'select') {
      buttons = `
        <span class="kc-label">SELECT:</span>
        <button onclick="sendKey('${n}', 'Up')" title="Move up">&#x2191;</button>
        <button onclick="sendKey('${n}', 'Down')" title="Move down">&#x2193;</button>
        <button onclick="sendKey('${n}', 'Enter')" title="Confirm selection">ENTER</button>
        <button onclick="sendKey('${n}', 'Escape')" title="Cancel">ESC</button>`;
    } else if (promptType === 'multiselect') {
      buttons = `
        <span class="kc-label">MULTI-SELECT:</span>
        <button onclick="sendKey('${n}', 'Up')" title="Move up">&#x2191;</button>
        <button onclick="sendKey('${n}', 'Down')" title="Move down">&#x2193;</button>
        <button onclick="sendKey('${n}', 'Space')" title="Toggle selection">SPACE</button>
        <button onclick="sendKey('${n}', 'Enter')" title="Confirm selections">ENTER</button>
        <button onclick="sendKey('${n}', 'Escape')" title="Cancel">ESC</button>`;
    } else if (promptType === 'permission') {
      buttons = `
        <span class="kc-label">PERMISSION:</span>
        <button onclick="sendKey('${n}', 'Up')" title="Move up">&#x2191;</button>
        <button onclick="sendKey('${n}', 'Down')" title="Move down">&#x2193;</button>
        <button onclick="sendKey('${n}', 'Enter')" title="Confirm">ENTER</button>
        <button onclick="sendKey('${n}', 'Escape')" title="Cancel">ESC</button>`;
    } else if (promptType === 'plan') {
      buttons = `
        <span class="kc-label">PLAN:</span>
        <button onclick="sendKey('${n}', 'Up')" title="Move up">&#x2191;</button>
        <button onclick="sendKey('${n}', 'Down')" title="Move down">&#x2193;</button>
        <button onclick="sendKey('${n}', 'Enter')" title="Confirm selection">ENTER</button>
        <button onclick="sendKey('${n}', 'Escape')" title="Cancel">ESC</button>
        <span style="color:var(--dim);font-size:10px;margin-left:4px">&middot; or type feedback below</span>`;
    } else if (promptType === 'yesno') {
      buttons = `
        <span class="kc-label">CONFIRM:</span>
        <button onclick="sendKey('${n}', 'Up')" title="Move up">&#x2191;</button>
        <button onclick="sendKey('${n}', 'Down')" title="Move down">&#x2193;</button>
        <button onclick="sendKey('${n}', 'Enter')" title="Confirm">ENTER</button>
        <button onclick="sendKey('${n}', 'Escape')" title="Cancel">ESC</button>`;
    }
    keyControlsBlock = `<div class="key-controls">${buttons}</div>`;
  }

  // Prompt input for all agents
  const placeholders = {
    running: 'Queue a message...',
    idle: 'Type a follow-up task...',
    completed: 'Send a new task to re-spawn...',
  };
  let placeholder = placeholders[agent.state] || 'Send a message...';
  if (promptType === 'plan') {
    placeholder = 'Type feedback for the plan...';
  }
  const promptBlock = `
    <div class="card-prompt">
      <div class="prompt-row">
        <span class="prompt-prefix">&gt;_</span>
        <textarea placeholder="${placeholder}"
                  onkeydown="handlePromptKey(event, '${agent.name}')"
                  id="prompt-${agent.name}"></textarea>
      </div>
    </div>`;

  // Hidden file input for uploads
  const fileInput = agent.state !== 'completed'
    ? `<input type="file" id="file-${agent.name}" style="display:none"
             onchange="uploadFile('${agent.name}', this)" accept="image/*,.pdf,.txt,.csv,.json,.md,.js,.ts,.py" />`
    : '';

  // Action buttons
  let actions = '';
  if (agent.state !== 'completed') {
    actions = `
      <div class="card-actions">
        <button class="btn-send" onclick="sendPrompt('${agent.name}')">SEND</button>
        <button onclick="document.getElementById('file-${agent.name}').click()">FILE</button>
        <button onclick="copyAttach('${agent.name}')">VIEW</button>
        <button class="btn-stop" onclick="confirmStop('${agent.name}')">STOP</button>
        <button onclick="openOutputViewer('${agent.name}')">VIEW OUTPUT</button>
      </div>`;
  } else {
    actions = `
      <div class="card-actions">
        <button class="btn-send" onclick="sendPrompt('${agent.name}')">RE-SPAWN</button>
        <button onclick="openOutputViewer('${agent.name}')">VIEW OUTPUT</button>
        <button class="btn-clear" onclick="confirmCleanup('${agent.name}')">CLEAR</button>
      </div>`;
  }

  const dropHandlers = agent.state !== 'completed'
    ? `ondragover="onCardFileDragOver(event, '${agent.name}')"
       ondragleave="onCardFileDragLeave(event)"
       ondrop="onCardFileDrop(event, '${agent.name}')"`
    : '';
  const dropHint = agent.state !== 'completed'
    ? '<div class="drop-hint">DROP FILE HERE</div>'
    : '';

  return `
    <div class="card" data-state="${agent.state}" data-name="${agent.name}"
         draggable="true"
         ondragstart="onDragStart(event, '${agent.name}')"
         ondragend="onDragEnd(event)"
         ${dropHandlers}>
      <div class="card-titlebar">
        <span>${escapeHtml(agent.label)}</span>
        <span style="display:flex;gap:6px;align-items:center">
          ${promptType ? `<span class="prompt-badge" onclick="openOutputViewer('${agent.name}')" title="Click to view & respond">${promptTypeLabel(promptType)}</span>` : ''}
          <span class="state-badge">${agent.state.toUpperCase()}</span>
        </span>
      </div>
      <div class="card-body">
        ${metaLines}
        ${activityBlock}
      </div>
      ${keyControlsBlock}
      ${promptBlock}
      ${fileInput}
      ${dropHint}
      ${actions}
    </div>`;
}

// ─── ACTIONS ───────────────────────────────────────────────────────────
async function spawnAgent() {
  const projectPath = document.getElementById('spawnProject').value.trim();
  const prompt = document.getElementById('spawnPrompt').value.trim();

  if (!projectPath || !prompt) {
    alert('Project path and prompt are required');
    return;
  }

  try {
    const res = await fetch('/api/agents', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ projectPath, prompt }),
    });
    const data = await res.json();
    if (data.error) {
      alert('Error: ' + data.error);
      return;
    }
    closeSpawnModal();
    fetchAgents();
  } catch (e) {
    alert('Failed to spawn agent: ' + e.message);
  }
}

async function sendPrompt(agentName) {
  const textarea = document.getElementById('prompt-' + agentName);
  if (!textarea) return;
  const message = textarea.value.trim();
  if (!message) return;

  textarea.value = '';

  // Check if this agent has a plan prompt - route to plan-feedback endpoint
  const agent = agents.find(a => a.name === agentName);
  const pType = agent ? (agent.promptType || detectPromptTypeFromText(agent.lastActivity || '')) : null;

  try {
    if (pType === 'plan') {
      await fetch(`/api/agents/${agentName}/plan-feedback`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });
    } else {
      await fetch(`/api/agents/${agentName}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });
    }
    fetchAgents();
  } catch (e) {
    console.error('Send error:', e);
  }
}

async function sendKey(agentName, key) {
  try {
    await fetch(`/api/agents/${agentName}/keys`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ keys: key }),
    });
  } catch (e) {
    console.error('Send key error:', e);
  }
}

function handlePromptKey(event, agentName) {
  if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
    event.preventDefault();
    sendPrompt(agentName);
  }
}

async function uploadFile(agentName, input) {
  const file = input.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch(`/api/agents/${agentName}/upload`, {
      method: 'POST',
      body: formData,
    });
    const data = await res.json();
    if (data.error) {
      alert('Upload error: ' + data.error);
    }
  } catch (e) {
    alert('Upload failed: ' + e.message);
  }
  // Reset the input so the same file can be re-selected
  input.value = '';
}

function copyAttach(agentName) {
  // On Windows, sessions are managed in-process via node-pty (no tmux).
  // Open the output viewer instead.
  openOutputViewer(agentName);
}

async function stopAgent(agentName) {
  try {
    await fetch(`/api/agents/${agentName}`, { method: 'DELETE' });
    fetchAgents();
  } catch (e) {
    console.error('Stop error:', e);
  }
}

function confirmStop(agentName) {
  pendingConfirm = () => stopAgent(agentName);
  document.getElementById('confirmMessage').textContent = `STOP AGENT "${agentName}"?`;
  document.getElementById('confirmOverlay').classList.add('active');
}

function confirmAction() {
  if (pendingConfirm) {
    pendingConfirm();
    pendingConfirm = null;
  }
  closeConfirm();
}

function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('active');
  document.getElementById('confirmBtn').textContent = 'STOP';
  pendingConfirm = null;
}

// ─── CLEANUP ───────────────────────────────────────────────────────────
async function cleanupAgent(agentName) {
  try {
    await fetch(`/api/agents/${agentName}/cleanup`, { method: 'DELETE' });
    fetchAgents();
  } catch (e) {
    console.error('Cleanup error:', e);
  }
}

async function cleanupAllCompleted() {
  try {
    await fetch('/api/cleanup/completed', { method: 'DELETE' });
    fetchAgents();
  } catch (e) {
    console.error('Cleanup all error:', e);
  }
}

function confirmCleanup(agentName) {
  pendingConfirm = () => cleanupAgent(agentName);
  document.getElementById('confirmMessage').textContent = `CLEAR COMPLETED AGENT "${agentName}"?`;
  document.getElementById('confirmBtn').textContent = 'CLEAR';
  document.getElementById('confirmOverlay').classList.add('active');
}

function confirmClearAll() {
  const count = agents.filter(a => a.state === 'completed').length;
  pendingConfirm = () => cleanupAllCompleted();
  document.getElementById('confirmMessage').textContent = `CLEAR ALL ${count} COMPLETED AGENT${count !== 1 ? 'S' : ''}?`;
  document.getElementById('confirmBtn').textContent = 'CLEAR ALL';
  document.getElementById('confirmOverlay').classList.add('active');
}

// ─── OUTPUT VIEWER ─────────────────────────────────────────────────────
async function openOutputViewer(agentName) {
  currentOutputAgent = agentName;
  const agent = agents.find(a => a.name === agentName);
  document.getElementById('outputTitle').textContent =
    `OUTPUT: ${agent ? agent.label : agentName}`;
  document.getElementById('outputOverlay').classList.add('active');
  document.getElementById('outputPromptInput').value = '';
  await updateOutputViewer();

  // Poll for output updates
  if (outputPollTimer) clearInterval(outputPollTimer);
  outputPollTimer = setInterval(updateOutputViewer, 3000);
}

async function updateOutputViewer() {
  if (!currentOutputAgent) return;
  try {
    const res = await fetch(`/api/agents/${currentOutputAgent}/output`);
    const data = await res.json();
    const el = document.getElementById('outputContent');
    const wasAtBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 50;
    el.innerHTML = data.raw ? ansiToHtml(data.raw) : escapeHtml(data.output || '(no output)');
    if (wasAtBottom) el.scrollTop = el.scrollHeight;

    // Show key controls if agent has an interactive prompt
    updateOutputKeyControls();
  } catch (e) {
    console.error('Output fetch error:', e);
  }
}

function detectPromptTypeFromText(text) {
  if (/space to select/i.test(text) && /enter to confirm/i.test(text)) return 'multiselect';
  if (/allow\s+(once|always)/i.test(text) && /deny/i.test(text)) return 'permission';
  // Plan detection before select (plan prompts also show "enter to select")
  if (/ctrl.g to edit/i.test(text)) return 'plan';
  if (/manually approve/i.test(text) && /\d\.\s/.test(text)) return 'plan';
  if (/execute.*plan/i.test(text) && /\d\.\s/.test(text)) return 'plan';
  if (/enter to select/i.test(text) && /to navigate/i.test(text)) return 'select';
  if (/\(y\/n\)/i.test(text)) return 'yesno';
  return null;
}

function updateOutputKeyControls() {
  const kcEl = document.getElementById('outputKeyControls');
  if (!currentOutputAgent || !kcEl) return;

  // Try server-side detection first, then fallback to client-side from rendered output
  const agent = agents.find(a => a.name === currentOutputAgent);
  let pType = agent ? agent.promptType : null;

  if (!pType) {
    // Detect from the output content text directly
    const outputEl = document.getElementById('outputContent');
    if (outputEl) {
      pType = detectPromptTypeFromText(outputEl.textContent || '');
    }
  }

  if (!pType) {
    kcEl.style.display = 'none';
    return;
  }

  let buttons = '';
  if (pType === 'select') {
    buttons = `
      <span class="kc-label">SELECT:</span>
      <button onclick="sendKeyFromOutput('Up')" title="Move up">&#x2191;</button>
      <button onclick="sendKeyFromOutput('Down')" title="Move down">&#x2193;</button>
      <button onclick="sendKeyFromOutput('Enter')" title="Confirm selection">ENTER</button>
      <button onclick="sendKeyFromOutput('Escape')" title="Cancel">ESC</button>`;
  } else if (pType === 'multiselect') {
    buttons = `
      <span class="kc-label">MULTI-SELECT:</span>
      <button onclick="sendKeyFromOutput('Up')" title="Move up">&#x2191;</button>
      <button onclick="sendKeyFromOutput('Down')" title="Move down">&#x2193;</button>
      <button onclick="sendKeyFromOutput('Space')" title="Toggle selection">SPACE</button>
      <button onclick="sendKeyFromOutput('Enter')" title="Confirm selections">ENTER</button>
      <button onclick="sendKeyFromOutput('Escape')" title="Cancel">ESC</button>`;
  } else if (pType === 'permission') {
    buttons = `
      <span class="kc-label">PERMISSION:</span>
      <button onclick="sendKeyFromOutput('Up')" title="Move up">&#x2191;</button>
      <button onclick="sendKeyFromOutput('Down')" title="Move down">&#x2193;</button>
      <button onclick="sendKeyFromOutput('Enter')" title="Confirm">ENTER</button>
      <button onclick="sendKeyFromOutput('Escape')" title="Cancel">ESC</button>`;
  } else if (pType === 'plan') {
    buttons = `
      <span class="kc-label">PLAN:</span>
      <button onclick="sendKeyFromOutput('Up')" title="Move up">&#x2191;</button>
      <button onclick="sendKeyFromOutput('Down')" title="Move down">&#x2193;</button>
      <button onclick="sendKeyFromOutput('Enter')" title="Confirm selection">ENTER</button>
      <button onclick="sendKeyFromOutput('Escape')" title="Cancel">ESC</button>
      <span style="color:var(--dim);font-size:10px;margin-left:4px">&middot; or type feedback below</span>`;
  } else if (pType === 'yesno') {
    buttons = `
      <span class="kc-label">CONFIRM:</span>
      <button onclick="sendKeyFromOutput('Up')" title="Move up">&#x2191;</button>
      <button onclick="sendKeyFromOutput('Down')" title="Move down">&#x2193;</button>
      <button onclick="sendKeyFromOutput('Enter')" title="Confirm">ENTER</button>
      <button onclick="sendKeyFromOutput('Escape')" title="Cancel">ESC</button>`;
  }

  if (buttons) {
    kcEl.innerHTML = buttons;
    kcEl.style.display = 'flex';
  } else {
    kcEl.style.display = 'none';
  }

  // Update output prompt placeholder based on prompt type
  const outputInput = document.getElementById('outputPromptInput');
  if (outputInput) {
    outputInput.placeholder = pType === 'plan' ? 'Type feedback for the plan...' : 'Send a message...';
  }
}

async function sendKeyFromOutput(key) {
  if (!currentOutputAgent) return;
  await sendKey(currentOutputAgent, key);
  // Refresh output immediately to show the effect
  setTimeout(updateOutputViewer, 300);
}

function closeOutputViewer() {
  currentOutputAgent = null;
  document.getElementById('outputOverlay').classList.remove('active');
  if (outputPollTimer) {
    clearInterval(outputPollTimer);
    outputPollTimer = null;
  }
}

async function sendFromOutput() {
  if (!currentOutputAgent) return;
  const input = document.getElementById('outputPromptInput');
  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  // Check if plan prompt is active - route to plan-feedback endpoint
  const agent = agents.find(a => a.name === currentOutputAgent);
  let pType = agent ? agent.promptType : null;
  if (!pType) {
    const outputEl = document.getElementById('outputContent');
    if (outputEl) pType = detectPromptTypeFromText(outputEl.textContent || '');
  }

  try {
    if (pType === 'plan') {
      await fetch(`/api/agents/${currentOutputAgent}/plan-feedback`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });
    } else {
      await fetch(`/api/agents/${currentOutputAgent}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });
    }
  } catch (e) {
    console.error('Send from output error:', e);
  }
}

// ─── SPAWN MODAL ───────────────────────────────────────────────────────
function openSpawnModal() {
  document.getElementById('spawnProject').value = '';
  document.getElementById('spawnPrompt').value = '';
  document.getElementById('spawnModal').classList.add('active');
  loadRecentProjects().then(() => {
    document.getElementById('spawnProject').focus();
  });
}

function closeSpawnModal() {
  document.getElementById('spawnModal').classList.remove('active');
  closeProjectDropdown();
  document.getElementById('folderPicker').classList.remove('active');
}

// ─── FOLDER PICKER ─────────────────────────────────────────────────────
async function toggleFolderPicker() {
  const picker = document.getElementById('folderPicker');
  if (picker.classList.contains('active')) {
    picker.classList.remove('active');
    return;
  }
  const current = document.getElementById('spawnProject').value.trim() || '';
  await loadFolderPicker(current || undefined);
}

async function loadFolderPicker(dir) {
  const picker = document.getElementById('folderPicker');
  try {
    const url = dir ? `/api/browse?dir=${encodeURIComponent(dir)}` : '/api/browse';
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) {
      picker.innerHTML = `<div class="fp-empty">${escapeHtml(data.error)}</div>`;
      picker.classList.add('active');
      return;
    }

    let html = `<div class="fp-header">
      <span>${escapeHtml(data.current)}</span>
      <button class="fp-select" onclick="selectFolder('${escapeAttr(data.current)}')">SELECT</button>
    </div>`;

    if (data.current !== data.parent) {
      html += `<div class="fp-item fp-parent" onclick="loadFolderPicker('${escapeAttr(data.parent)}')">..</div>`;
    }

    if (data.dirs.length === 0) {
      html += '<div class="fp-empty">NO SUBDIRECTORIES</div>';
    } else {
      for (const d of data.dirs) {
        const full = data.current === '/' ? '/' + d : data.current + '/' + d;
        html += `<div class="fp-item" onclick="loadFolderPicker('${escapeAttr(full)}')">${escapeHtml(d)}</div>`;
      }
    }

    picker.innerHTML = html;
    picker.classList.add('active');
  } catch (e) {
    picker.innerHTML = '<div class="fp-empty">FAILED TO BROWSE</div>';
    picker.classList.add('active');
  }
}

function selectFolder(path) {
  document.getElementById('spawnProject').value = path;
  document.getElementById('folderPicker').classList.remove('active');
  document.getElementById('spawnPrompt').focus();
}

function escapeAttr(str) {
  return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

// ─── RECENT PROJECTS COMBO BOX ─────────────────────────────────────────
let recentProjects = [];
let comboActiveIdx = -1;

async function loadRecentProjects() {
  try {
    const res = await fetch('/api/recent-projects');
    recentProjects = await res.json();
  } catch (e) {
    recentProjects = [];
  }
}

function renderProjectDropdown(items) {
  const dd = document.getElementById('projectDropdown');
  comboActiveIdx = -1;
  if (!items.length) {
    dd.innerHTML = '<div class="combo-empty">No recent projects</div>';
  } else {
    dd.innerHTML = items.map((p, i) =>
      `<div class="combo-option" data-index="${i}" onmousedown="selectProject('${p.replace(/'/g, "\\'")}')">${p}</div>`
    ).join('');
  }
  dd.classList.add('open');
}

function filterRecentProjects() {
  const q = document.getElementById('spawnProject').value.toLowerCase();
  const filtered = q ? recentProjects.filter(p => p.toLowerCase().includes(q)) : recentProjects;
  renderProjectDropdown(filtered);
}

function toggleProjectDropdown() {
  const dd = document.getElementById('projectDropdown');
  if (dd.classList.contains('open')) {
    closeProjectDropdown();
  } else {
    filterRecentProjects();
    document.getElementById('spawnProject').focus();
  }
}

function closeProjectDropdown() {
  document.getElementById('projectDropdown').classList.remove('open');
  comboActiveIdx = -1;
}

function selectProject(p) {
  document.getElementById('spawnProject').value = p;
  closeProjectDropdown();
}

function comboKeydown(e) {
  const dd = document.getElementById('projectDropdown');
  const opts = dd.querySelectorAll('.combo-option');
  if (!dd.classList.contains('open') || !opts.length) {
    if (e.key === 'Escape') closeProjectDropdown();
    return;
  }
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    comboActiveIdx = Math.min(comboActiveIdx + 1, opts.length - 1);
    updateComboActive(opts);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    comboActiveIdx = Math.max(comboActiveIdx - 1, 0);
    updateComboActive(opts);
  } else if (e.key === 'Enter' && comboActiveIdx >= 0) {
    e.preventDefault();
    opts[comboActiveIdx].onmousedown();
  } else if (e.key === 'Escape') {
    closeProjectDropdown();
  }
}

function updateComboActive(opts) {
  opts.forEach((el, i) => el.classList.toggle('active', i === comboActiveIdx));
  if (comboActiveIdx >= 0 && opts[comboActiveIdx]) {
    opts[comboActiveIdx].scrollIntoView({ block: 'nearest' });
  }
}

// Close dropdown on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.combo-wrapper')) closeProjectDropdown();
});

// ─── DRAG AND DROP ─────────────────────────────────────────────────────
function onDragStart(event, agentName) {
  draggedAgentName = agentName;
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/plain', agentName);
  event.target.classList.add('dragging');
}

function onDragEnd(event) {
  event.target.classList.remove('dragging');
  draggedAgentName = null;
  // Remove all drag-over classes
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function onDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  event.currentTarget.classList.add('drag-over');
}

function onDragLeave(event) {
  event.currentTarget.classList.remove('drag-over');
}

function onDrop(event) {
  event.preventDefault();
  event.currentTarget.classList.remove('drag-over');

  const agentName = event.dataTransfer.getData('text/plain');
  if (!agentName) return;

  confirmStop(agentName);
}

// ─── KEYBOARD SHORTCUTS ───────────────────────────────────────────────
document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape') {
    if (document.getElementById('outputOverlay').classList.contains('active')) {
      closeOutputViewer();
    } else if (document.getElementById('spawnModal').classList.contains('active')) {
      closeSpawnModal();
    } else if (document.getElementById('confirmOverlay').classList.contains('active')) {
      closeConfirm();
    }
  }

  // 'n' to open spawn modal (when not typing in an input)
  const tag = document.activeElement.tagName;
  if (event.key === 'n' && tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT') {
    const anyOverlay = document.querySelector('.modal-overlay.active, .output-overlay.active, .confirm-overlay.active');
    if (!anyOverlay) {
      event.preventDefault();
      openSpawnModal();
    }
  }
});

// ─── ANSI TO HTML ─────────────────────────────────────────────────────
function ansi256ToHex(n) {
  n = parseInt(n);
  const std = ['#555','#ff5555','#50fa7b','#f1fa8c','#bd93f9','#ff79c6','#8be9fd','#f8f8f2',
               '#6272a4','#ff6e6e','#69ff94','#ffffa5','#d6acff','#ff92df','#a4ffff','#ffffff'];
  if (n < 16) return std[n];
  if (n >= 232) {
    const g = 8 + (n - 232) * 10;
    const h = Math.min(255, g).toString(16).padStart(2, '0');
    return `#${h}${h}${h}`;
  }
  const idx = n - 16;
  const r = Math.floor(idx / 36);
  const gc = Math.floor((idx % 36) / 6);
  const b = idx % 6;
  const toH = v => (v === 0 ? 0 : 55 + v * 40).toString(16).padStart(2, '0');
  return `#${toH(r)}${toH(gc)}${toH(b)}`;
}

function ansiToHtml(str) {
  if (!str) return '';

  const fgMap = {
    '30':'#555','31':'#ff5555','32':'#50fa7b','33':'#f1fa8c',
    '34':'#bd93f9','35':'#ff79c6','36':'#8be9fd','37':'#f8f8f2',
    '90':'#6272a4','91':'#ff6e6e','92':'#69ff94','93':'#ffffa5',
    '94':'#d6acff','95':'#ff92df','96':'#a4ffff','97':'#ffffff',
  };
  const bgMap = {
    '40':'#555','41':'#ff5555','42':'#50fa7b','43':'#f1fa8c',
    '44':'#bd93f9','45':'#ff79c6','46':'#8be9fd','47':'#f8f8f2',
    '100':'#6272a4','101':'#ff6e6e','102':'#69ff94','103':'#ffffa5',
    '104':'#d6acff','105':'#ff92df','106':'#a4ffff','107':'#ffffff',
  };

  // Escape HTML first
  let out = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

  let openSpans = 0;
  out = out.replace(/\x1B\[([0-9;]*)m/g, (_, codes) => {
    if (!codes || codes === '0') {
      const c = '</span>'.repeat(openSpans);
      openSpans = 0;
      return c;
    }
    const parts = codes.split(';');
    let styles = [];
    for (let i = 0; i < parts.length; i++) {
      const p = parts[i];
      if (p === '1') styles.push('font-weight:bold');
      else if (p === '2') styles.push('opacity:0.7');
      else if (p === '3') styles.push('font-style:italic');
      else if (p === '4') styles.push('text-decoration:underline');
      else if (fgMap[p]) styles.push('color:' + fgMap[p]);
      else if (bgMap[p]) styles.push('background:' + bgMap[p]);
      else if (p === '38' && parts[i+1] === '5' && parts[i+2]) {
        styles.push('color:' + ansi256ToHex(parts[i+2]));
        i += 2;
      } else if (p === '48' && parts[i+1] === '5' && parts[i+2]) {
        styles.push('background:' + ansi256ToHex(parts[i+2]));
        i += 2;
      } else if (p === '38' && parts[i+1] === '2' && parts[i+4]) {
        // 24-bit color: 38;2;r;g;b
        styles.push(`color:rgb(${parts[i+2]},${parts[i+3]},${parts[i+4]})`);
        i += 4;
      } else if (p === '48' && parts[i+1] === '2' && parts[i+4]) {
        styles.push(`background:rgb(${parts[i+2]},${parts[i+3]},${parts[i+4]})`);
        i += 4;
      }
    }
    if (styles.length > 0) {
      openSpans++;
      return `<span style="${styles.join(';')}">`;
    }
    return '';
  });

  out += '</span>'.repeat(openSpans);

  // Strip remaining escape sequences
  out = out.replace(/\x1B\[[0-9;]*[a-zA-Z]/g, '');
  out = out.replace(/\x1B\][^\x07]*\x07/g, '');
  out = out.replace(/\x1B\([A-Z0-9]/g, '');
  out = out.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, '');

  return out;
}

// ─── FILE DRAG & DROP ON CARDS ────────────────────────────────────────
function onCardFileDragOver(event, agentName) {
  // Only react to file drags, not card drags
  if (draggedAgentName) return;
  if (!event.dataTransfer.types.includes('Files')) return;
  event.preventDefault();
  event.stopPropagation();
  event.dataTransfer.dropEffect = 'copy';
  event.currentTarget.closest('.card').classList.add('file-drag-over');
}

function onCardFileDragLeave(event) {
  const card = event.currentTarget.closest('.card');
  // Only remove if we're actually leaving the card (not entering a child)
  if (!card.contains(event.relatedTarget)) {
    card.classList.remove('file-drag-over');
  }
}

function onCardFileDrop(event, agentName) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.closest('.card').classList.remove('file-drag-over');

  const files = event.dataTransfer.files;
  if (!files || files.length === 0) return;

  const file = files[0];
  const formData = new FormData();
  formData.append('file', file);

  fetch(`/api/agents/${agentName}/upload`, {
    method: 'POST',
    body: formData,
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) console.error('Drop upload error:', data.error);
  })
  .catch(e => console.error('Drop upload failed:', e));
}

// ─── HELPERS ───────────────────────────────────────────────────────────
function formatDuration(ms) {
  const seconds = Math.floor(ms / 1000);
  if (seconds < 60) return `${seconds}s`;
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  if (minutes < 60) return `${minutes}m ${secs}s`;
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hours}h ${mins}m`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function promptTypeLabel(type) {
  const labels = {
    select: 'SELECT',
    multiselect: 'MULTI-SELECT',
    permission: 'PERMISSION',
    plan: 'PLAN APPROVAL',
    yesno: 'YES/NO',
  };
  return labels[type] || type.toUpperCase();
}

// ─── MOBILE TAB SWITCHING ───────────────────────────────────────────
let activeTab = 'running';

function isMobile() {
  return window.matchMedia('(max-width: 768px)').matches;
}

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.mobile-tabs .tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === tab);
  });
  document.querySelectorAll('.column').forEach(col => {
    col.classList.toggle('mobile-active', col.dataset.state === tab);
  });
}

function updateMobileTabs() {
  const running = agents.filter(a => a.state === 'running');
  const idle = agents.filter(a => a.state === 'idle');
  const completed = agents.filter(a => a.state === 'completed');

  const tabRun = document.getElementById('tabRunCount');
  const tabIdle = document.getElementById('tabIdleCount');
  const tabDone = document.getElementById('tabDoneCount');
  if (tabRun) tabRun.textContent = `[${running.length}]`;
  if (tabIdle) tabIdle.textContent = `[${idle.length}]`;
  if (tabDone) tabDone.textContent = `[${completed.length}]`;
}

function initMobileLayout() {
  if (isMobile()) {
    switchTab(activeTab);
  } else {
    document.querySelectorAll('.column').forEach(col => {
      col.classList.remove('mobile-active');
    });
  }
}

window.addEventListener('resize', initMobileLayout);

// ─── VIEW SWITCHING ────────────────────────────────────────────────────
let currentView = 'agents';

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.view-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.view === view);
  });
  document.getElementById('agentsView').classList.toggle('active', view === 'agents');
  document.getElementById('teamsView').classList.toggle('active', view === 'teams');

  // Show/hide spawn button (only in agents view)
  const spawnBtn = document.querySelector('.spawn-btn');
  if (spawnBtn) spawnBtn.style.display = view === 'agents' ? '' : 'none';
  const fab = document.querySelector('.fab');
  if (fab) fab.style.display = (view === 'agents' && isMobile()) ? 'flex' : 'none';

  if (view === 'teams') {
    fetchTeams();
  }
}

// ─── TEAMS STATE ───────────────────────────────────────────────────────
let teamsList = [];
let teamsData = {};
let selectedTeam = null;
let timelineFilter = 'all'; // 'all' or 'important'

async function fetchTeams() {
  try {
    const res = await fetch('/api/teams');
    teamsList = await res.json();
    renderTeamList();
    if (selectedTeam) {
      await fetchTeamDetail(selectedTeam);
    }
  } catch (e) {
    console.error('Fetch teams error:', e);
  }
}

async function fetchTeamDetail(teamName) {
  try {
    const res = await fetch(`/api/teams/${encodeURIComponent(teamName)}/full`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    teamsData[teamName] = data;
    renderTeamDetail(teamName);
  } catch (e) {
    console.error('Fetch team detail error:', e);
  }
}

function selectTeam(teamName) {
  selectedTeam = teamName;
  renderTeamList();
  fetchTeamDetail(teamName);
}

// ─── TEAMS RENDERING ──────────────────────────────────────────────────

function renderTeamList() {
  const body = document.getElementById('teamListBody');
  if (teamsList.length === 0) {
    body.innerHTML = '<div class="team-list-empty">NO TEAMS DETECTED</div>';
    return;
  }

  body.innerHTML = teamsList.map(team => {
    const dotClass = team.hasActiveMembers ? 'active' : (team.totalTasks > 0 ? 'idle' : 'inactive');
    const isActive = selectedTeam === team.name;
    return `
      <div class="team-list-item${isActive ? ' active' : ''}" onclick="selectTeam('${escapeAttr(team.name)}')">
        <div class="tli-name">
          <span class="tli-dot ${dotClass}"></span>
          ${escapeHtml(team.name)}
        </div>
        <div class="tli-meta">${team.memberCount} MEMBERS &middot; ${team.activeTasks}/${team.totalTasks} TASKS</div>
      </div>`;
  }).join('');
}

function renderTeamDetail(teamName) {
  const detail = document.getElementById('teamDetail');
  const data = teamsData[teamName];
  if (!data || !data.config) {
    detail.innerHTML = '<div class="team-detail-empty">FAILED TO LOAD TEAM</div>';
    return;
  }

  const members = data.config.members || [];
  const tasks = data.tasks || [];
  const events = data.events || [];
  const messages = data.messages || [];

  const inProgressOwners = new Set(
    tasks.filter(t => t.status === 'in_progress' && t.owner).map(t => t.owner)
  );

  // Task summary for status bar
  const pendingCount = tasks.filter(t => t.status === 'pending').length;
  const activeCount = tasks.filter(t => t.status === 'in_progress').length;
  const doneCount = tasks.filter(t => t.status === 'completed').length;

  detail.innerHTML = `
    <div class="team-members-bar" id="teamMembersBar">
      ${renderMemberCards(members, tasks, inProgressOwners, data.memberSummary, data.messages, events)}
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="timeline-filter">
          <span class="filter-btn ${timelineFilter === 'all' ? 'active' : ''}" onclick="setTimelineFilter('all')">全部</span>
          <span class="filter-btn ${timelineFilter === 'important' ? 'active' : ''}" onclick="setTimelineFilter('important')">重要</span>
        </div>
        <span style="font-size:10px;color:var(--dim);letter-spacing:1px">TASKS: ${pendingCount}/${activeCount}/${doneCount}</span>
      </div>
    </div>
    <div class="team-timeline" id="teamTimeline">
      ${renderTimeline(events)}
    </div>
    <div class="boss-input">
      <select id="bossTarget">
        <option value="__all__">@ALL</option>
        ${members.map(m => `<option value="${escapeAttr(m.name || m.agentId)}">@${escapeHtml(m.name || m.agentId)}</option>`).join('')}
      </select>
      <input type="text" id="bossInput" placeholder="Send message..."
             onkeydown="if(event.key==='Enter')sendBossMessage('${escapeAttr(teamName)}')" />
      <button onclick="sendBossMessage('${escapeAttr(teamName)}')">SEND</button>
      <div class="quick-actions">
        <button class="quick-btn" onclick="quickBossMessage('${escapeAttr(teamName)}','Approved, proceed.')">APPROVE</button>
        <button class="quick-btn" onclick="quickBossMessage('${escapeAttr(teamName)}','Rejected, revise the approach.')">REJECT</button>
        <button class="quick-btn" onclick="quickBossMessage('${escapeAttr(teamName)}','Continue working.')">CONTINUE</button>
      </div>
    </div>`;

  // Auto-scroll timeline to bottom
  const timeline = document.getElementById('teamTimeline');
  if (timeline) timeline.scrollTop = timeline.scrollHeight;
}

function renderMemberCards(members, tasks, inProgressOwners, memberSummary, messages, events) {
  if (members.length === 0) return '<div style="color:var(--dim);font-size:11px;padding:4px">NO MEMBERS</div>';

  return members.map(m => {
    const name = m.name || m.agentId || 'unknown';
    const summary = memberSummary?.[name] || {};
    const isAlive = summary.isAlive !== undefined ? summary.isAlive : true;
    const isWorking = inProgressOwners.has(name);
    const completedAll = tasks.length > 0 && tasks.every(t => t.status === 'completed');

    let dotClass, statusClass;
    if (!isAlive) { dotClass = 'offline'; statusClass = 'offline'; }
    else if (isWorking) { dotClass = 'working'; statusClass = 'working'; }
    else if (completedAll) { dotClass = 'offline'; statusClass = 'offline'; }
    else { dotClass = 'idle'; statusClass = 'idle'; }

    // Find current in_progress task with activeForm
    const activeTask = tasks.find(t => t.status === 'in_progress' && t.owner === name);
    const activeForm = activeTask ? (activeTask.activeForm || activeTask.subject || '') : '';

    // Find last message sent by this member — check both inbox and transcript events
    const memberMsgs = (messages || []).filter(msg => msg.from === name);
    const lastInboxMsg = memberMsgs.length > 0 ? memberMsgs[memberMsgs.length - 1] : null;

    // Also check transcript events for latest activity
    const memberEvents = (events || []).filter(ev => ev.actor === name && ev.type === 'agent_message');
    const lastEvent = memberEvents.length > 0 ? memberEvents[memberEvents.length - 1] : null;

    // Pick the best activity text
    let activityText = '';
    if (activeForm) {
      activityText = '';  // Will use dedicated task label
    } else if (lastEvent) {
      activityText = (lastEvent.summary || '').substring(0, 80);
    } else if (lastInboxMsg) {
      activityText = (lastInboxMsg.text || '').substring(0, 80);
    }

    // Build activity line
    let activityHtml = '';
    if (activeForm) {
      activityHtml = `<div class="mc-task-label">${escapeHtml(activeForm)}</div>`;
    } else if (activityText) {
      activityHtml = `<div class="mc-activity" title="${escapeAttr(activityText)}">${escapeHtml(activityText.substring(0, 60))}${activityText.length > 60 ? '...' : ''}</div>`;
    }

    return `
      <div class="member-card clickable" onclick="openMemberModal('${escapeAttr(selectedTeam)}', '${escapeAttr(name)}')">
        <div class="mc-name">
          <span class="mc-dot ${dotClass}"></span>
          ${escapeHtml(name)}
        </div>
        <div class="mc-status ${statusClass}">${isAlive ? (isWorking ? 'working' : 'online') : 'offline'}</div>
        ${activityHtml}
      </div>`;
  }).join('');
}

function renderTimeline(events) {
  if (!events || events.length === 0) {
    return '<div class="tl-empty">NO ACTIVITY YET</div>';
  }

  // Filter events based on timelineFilter
  const importantTypes = ['task_completed', 'task_started', 'plan_approval', 'plan_approval_response', 'shutdown', 'shutdown_approved', 'boss_message', 'agent_message', 'broadcast', 'peer_dm'];
  const filteredEvents = timelineFilter === 'important'
    ? events.filter(ev => importantTypes.includes(ev.type))
    : events;

  if (filteredEvents.length === 0) {
    return '<div class="tl-empty">NO IMPORTANT ACTIVITY</div>';
  }

  // Build agent color map for consistent coloring
  const agentColorMap = {};
  let colorIdx = 0;
  filteredEvents.forEach(ev => {
    if (ev.actor && !agentColorMap[ev.actor]) {
      agentColorMap[ev.actor] = colorIdx++ % 8;
    }
  });

  return filteredEvents.map((ev, idx) => {
    const time = formatMessageTime(ev.timestamp);
    const actor = ev.actor || 'unknown';
    const summary = ev.summary || '';
    const type = ev.type || 'message';
    const detail = ev.detail || '';
    const direction = ev.direction || '';
    const actorColor = agentColorMap[actor] !== undefined ? agentColorMap[actor] : 0;

    let mark = '';
    if (type === 'task_completed') mark = '\u2713';
    else if (type === 'task_started') mark = '\u25B6';
    else if (type === 'plan_approval') mark = '\u2696';
    else if (type === 'shutdown' || type === 'shutdown_approved') mark = '\u23FB';
    else if (type === 'broadcast') mark = '\uD83D\uDCE2';
    else if (type === 'agent_message') mark = '\uD83D\uDCAC';
    else if (type === 'peer_dm') mark = '\u21C4';

    // For message-type events, show direction (A → B)
    const isMsg = ['message', 'boss_message', 'broadcast', 'agent_message', 'peer_dm'].includes(type);
    const directionHtml = isMsg && direction
      ? `<span class="tl-direction">${escapeHtml(direction)}</span>`
      : '';

    // Show expand hint if there's more detail than summary
    const hasExpandable = detail && detail.length > summary.length;
    const expandHint = hasExpandable ? '<span class="tl-expand-hint">[+]</span>' : '';

    return `
      <div class="tl-event" data-type="${escapeAttr(type)}" onclick="toggleEventDetail(${idx})">
        <span class="tl-time">${time}</span>
        <span class="tl-actor tl-role-${actorColor}">${escapeHtml(actor)}</span>
        ${directionHtml}
        <span class="tl-summary">${escapeHtml(summary)}</span>
        ${expandHint}
        ${mark ? `<span class="tl-mark">${mark}</span>` : ''}
      </div>
      ${detail ? `<div class="tl-detail" id="tlDetail${idx}">${escapeHtml(detail)}</div>` : ''}`;
  }).join('');
}

function setTimelineFilter(mode) {
  timelineFilter = mode;
  if (selectedTeam) {
    renderTeamDetail(selectedTeam);
  }
}

function formatMessageTime(ts) {
  if (!ts) return '--:--:--';
  const d = typeof ts === 'string' ? new Date(ts) : new Date(ts);
  if (isNaN(d.getTime())) return '--:--:--';
  return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function toggleEventDetail(idx) {
  const el = document.getElementById('tlDetail' + idx);
  if (el) el.classList.toggle('open');
}

// Handle SSE team updates
function handleTeamsUpdate(data) {
  teamsList = data.teams || [];
  if (data.teamsData) {
    teamsData = data.teamsData;
  }
  if (currentView === 'teams') {
    renderTeamList();
    if (selectedTeam && teamsData[selectedTeam]) {
      renderTeamDetail(selectedTeam);
    }
  }
}

// ─── MEMBER DETAIL MODAL ────────────────────────────────────────────
let memberModalTeam = null;
let memberModalAgent = null;
let memberTranscriptTimer = null;

function openMemberModal(teamName, agentName) {
  memberModalTeam = teamName;
  memberModalAgent = agentName;

  const data = teamsData[teamName];
  const members = data?.config?.members || [];
  const member = members.find(m => (m.name || m.agentId) === agentName);
  const summary = data?.memberSummary?.[agentName] || {};
  const tasks = data?.tasks || [];

  // Header
  document.getElementById('mmName').textContent = agentName;
  document.getElementById('mmModel').textContent = member?.model || summary.model || '';

  // Dot status
  const dot = document.getElementById('mmDot');
  const inProgressOwners = new Set(tasks.filter(t => t.status === 'in_progress' && t.owner).map(t => t.owner));
  const isWorking = inProgressOwners.has(agentName);
  const isAlive = summary.isAlive !== undefined ? summary.isAlive : true;
  dot.className = 'mc-dot ' + (!isAlive ? 'offline' : isWorking ? 'working' : 'idle');

  // Info sidebar
  const sidebar = document.getElementById('mmInfoSidebar');
  const prompt = member?.prompt || summary.prompt || '';
  const agentType = member?.agentType || summary.agentType || '';
  const ownedTasks = tasks.filter(t => t.owner === agentName);
  const activeT = ownedTasks.filter(t => t.status === 'in_progress');

  let infoHtml = '';

  if (!isAlive) {
    const lastActiveText = summary.lastActiveAt ? timeAgo(summary.lastActiveAt) : 'unknown';
    infoHtml += `<div class="mm-info-section" style="background:rgba(255,68,68,0.1);border:1px solid var(--red);padding:8px;margin-bottom:8px">
      <div style="color:var(--red);font-weight:700;font-size:11px;letter-spacing:2px">OFFLINE</div>
      <div style="color:var(--dim);font-size:10px;margin-top:2px">Last active: ${escapeHtml(lastActiveText)}</div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="wakeTeamAgent('${escapeAttr(teamName)}','${escapeAttr(agentName)}','resume')" style="background:var(--green);color:#000;border:none;padding:4px 10px;font-family:var(--font);font-size:10px;font-weight:700;cursor:pointer;letter-spacing:1px">RESUME LEAD</button>
        <button onclick="wakeTeamAgent('${escapeAttr(teamName)}','${escapeAttr(agentName)}','fresh')" style="background:none;border:1px solid var(--amber);color:var(--amber);padding:4px 10px;font-family:var(--font);font-size:10px;font-weight:700;cursor:pointer;letter-spacing:1px">START FRESH</button>
      </div>
    </div>`;
  }

  if (agentType) {
    infoHtml += `<div class="mm-info-section">
      <div class="mm-info-label">AGENT TYPE</div>
      <div class="mm-info-value">${escapeHtml(agentType)}</div>
    </div>`;
  }

  infoHtml += `<div class="mm-info-section">
    <div class="mm-info-label">TASKS</div>
    <div class="mm-info-value">${activeT.length} active / ${ownedTasks.length} total</div>
  </div>`;

  if (activeT.length > 0) {
    infoHtml += `<div class="mm-info-section">
      <div class="mm-info-label">CURRENT TASK</div>
      <div class="mm-info-value">${escapeHtml(activeT[0].subject || '(no subject)')}</div>
      ${activeT[0].activeForm ? `<div class="mm-info-value dim" style="font-style:italic">${escapeHtml(activeT[0].activeForm)}</div>` : ''}
    </div>`;
  }

  infoHtml += `<div class="mm-info-section">
    <div class="mm-info-label">TOKEN USAGE</div>
    <div class="mm-usage" id="mmUsage">
      <span class="mm-usage-item"><span class="usage-label">IN:</span> <span class="usage-val" id="mmUsageIn">--</span></span>
      <span class="mm-usage-item"><span class="usage-label">OUT:</span> <span class="usage-val" id="mmUsageOut">--</span></span>
    </div>
  </div>`;

  if (prompt) {
    infoHtml += `<div class="mm-info-section">
      <div class="mm-info-label">ROLE PROMPT</div>
      <div class="mm-prompt-text">${escapeHtml(prompt.substring(0, 2000))}</div>
    </div>`;
  }

  sidebar.innerHTML = infoHtml;

  // Show modal
  document.getElementById('memberModal').classList.add('active');

  // Fetch transcript
  fetchMemberTranscript();

  // Poll for updates
  if (memberTranscriptTimer) clearInterval(memberTranscriptTimer);
  memberTranscriptTimer = setInterval(fetchMemberTranscript, 5000);
}

function closeMemberModal() {
  document.getElementById('memberModal').classList.remove('active');
  memberModalTeam = null;
  memberModalAgent = null;
  if (memberTranscriptTimer) {
    clearInterval(memberTranscriptTimer);
    memberTranscriptTimer = null;
  }
}

async function fetchMemberTranscript() {
  if (!memberModalTeam || !memberModalAgent) return;
  try {
    const res = await fetch(`/api/teams/${encodeURIComponent(memberModalTeam)}/members/${encodeURIComponent(memberModalAgent)}/transcript?tail=50`);
    const data = await res.json();

    // Update usage
    if (data.usage) {
      const inEl = document.getElementById('mmUsageIn');
      const outEl = document.getElementById('mmUsageOut');
      if (inEl) inEl.textContent = formatTokens(data.usage.inputTokens);
      if (outEl) outEl.textContent = formatTokens(data.usage.outputTokens);
    }

    // Update count
    const countEl = document.getElementById('mmTranscriptCount');
    if (countEl) countEl.textContent = `[${data.totalMessages || 0}]`;

    // Render messages
    const body = document.getElementById('mmTranscriptBody');
    const wasAtBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 50;

    if (!data.messages || data.messages.length === 0) {
      body.innerHTML = `<div class="mm-transcript-empty">${data.info || data.error || 'NO CONVERSATION YET'}</div>`;
    } else {
      body.innerHTML = data.messages.map(msg => {
        const roleClass = msg.role || 'user';
        const roleLabel = msg.role === 'user' ? 'USER' : msg.role === 'assistant' ? 'ASSISTANT' : 'TOOL';
        let toolsHtml = '';
        if (msg.toolUse && msg.toolUse.length > 0) {
          toolsHtml = '<div class="mm-msg-tools">' + msg.toolUse.map(t =>
            `<div class="mm-msg-tool-item"><span class="tool-name">${escapeHtml(t.name)}</span> ${escapeHtml(t.input)}</div>`
          ).join('') + '</div>';
        }
        const text = msg.text || '';
        const displayText = text.length > 1000 ? text.substring(0, 1000) + '...' : text;
        return `<div class="mm-msg ${roleClass}">
          <div class="mm-msg-role">${roleLabel}</div>
          <div class="mm-msg-text">${escapeHtml(displayText)}</div>
          ${toolsHtml}
        </div>`;
      }).join('');
    }

    if (wasAtBottom) body.scrollTop = body.scrollHeight;
  } catch (e) {
    console.error('Fetch transcript error:', e);
  }
}

async function sendToTeamAgent() {
  if (!memberModalTeam || !memberModalAgent) return;
  const input = document.getElementById('mmSendInput');
  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  try {
    await fetch(`/api/teams/${encodeURIComponent(memberModalTeam)}/members/${encodeURIComponent(memberModalAgent)}/send`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message }),
    });
  } catch (e) {
    console.error('Send to team agent error:', e);
  }
}

async function shutdownTeamAgent() {
  if (!memberModalTeam || !memberModalAgent) return;
  if (!confirm(`Send SHUTDOWN request to ${memberModalAgent}?`)) return;

  try {
    await fetch(`/api/teams/${encodeURIComponent(memberModalTeam)}/members/${encodeURIComponent(memberModalAgent)}/shutdown`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (e) {
    console.error('Shutdown team agent error:', e);
  }
}

async function sendBossMessage(teamName) {
  const select = document.getElementById('bossTarget');
  const input = document.getElementById('bossInput');
  if (!select || !input) return;
  const target = select.value;
  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  const data = teamsData[teamName];
  const members = data?.config?.members || [];

  if (target === '__all__') {
    for (const m of members) {
      const name = m.name || m.agentId;
      try {
        await fetch(`/api/teams/${encodeURIComponent(teamName)}/members/${encodeURIComponent(name)}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message }),
        });
      } catch (e) { console.error('Send error:', e); }
    }
  } else {
    try {
      await fetch(`/api/teams/${encodeURIComponent(teamName)}/members/${encodeURIComponent(target)}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });
    } catch (e) { console.error('Send error:', e); }
  }
}

function quickBossMessage(teamName, message) {
  const input = document.getElementById('bossInput');
  if (input) {
    input.value = message;
    sendBossMessage(teamName);
  }
}

async function updateTeamTask(teamName, taskId, field, value) {
  try {
    const body = {};
    body[field] = value;
    await fetch(`/api/teams/${encodeURIComponent(teamName)}/tasks/${encodeURIComponent(taskId)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
  } catch (e) {
    console.error('Update task error:', e);
  }
}

function timeAgo(timestamp) {
  const ms = Date.now() - (typeof timestamp === 'string' ? new Date(timestamp).getTime() : timestamp);
  if (ms < 60000) return 'just now';
  if (ms < 3600000) return Math.floor(ms / 60000) + 'm ago';
  if (ms < 86400000) return Math.floor(ms / 3600000) + 'h ago';
  return Math.floor(ms / 86400000) + 'd ago';
}

async function wakeTeamAgent(teamName, agentName, mode) {
  if (!mode) {
    // Show choice dialog
    mode = prompt('Wake mode?\n\n1. resume — Resume lead session (recommended)\n2. fresh — Start fresh agent\n\nType "resume" or "fresh":', 'resume');
    if (!mode || (mode !== 'resume' && mode !== 'fresh')) return;
  }

  try {
    const body = { mode };
    if (mode === 'fresh') body.targetAgent = agentName;

    const res = await fetch(`/api/teams/${encodeURIComponent(teamName)}/wake`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.error) {
      alert('Wake failed: ' + data.error);
    } else {
      alert(`Agent waking up! Session: ${data.sessionName}\nCheck the Agents tab to monitor.`);
      // Switch to agents view to see the new session
      if (typeof switchView === 'function') switchView('agents');
    }
  } catch (e) {
    alert('Wake request failed: ' + e.message);
  }
}

function formatTokens(n) {
  if (!n || n === 0) return '0';
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return String(n);
}

// ─── INIT ──────────────────────────────────────────────────────────────
fetchAgents();
connectSSE();
initMobileLayout();

// Close member modal on Escape
document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape' && document.getElementById('memberModal').classList.contains('active')) {
    closeMemberModal();
  }
});
</script>
</body>
</html>
